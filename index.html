<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0f17" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./images/icon-192.png" />
  <title>EliteTraining</title>

  <style>
    :root{
      --bg:#0b0f17; --card:#121a29; --muted:#9fb0c7; --text:#eaf1ff;
      --accent:#4ea1ff; --accent2:#00d4ff; --danger:#ff4e6a;
      --btn:#1a2740; --btn2:#223454;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 20px;
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
    }
    [data-theme="light"]{
      --bg:#f5f7fb; --card:#ffffff; --muted:#4f6076; --text:#0b1526;
      --accent:#1976ff; --accent2:#0aa3c2;
      --btn:#e9eef9; --btn2:#dde7fb;
      --shadow: 0 10px 30px rgba(10,20,40,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      /* Safe-area top is handled by the sticky topbar so it stays clear of the
         notch/status bar while scrolling (and avoids double-padding). */
      padding-top: 0;
      padding-bottom: var(--safe-bot);
      overscroll-behavior: none;
      touch-action: manipulation;
    }
    a{color:inherit}
    .app{max-width:520px;margin:0 auto; padding:14px 14px 20px}
    body.inWorkout .app{ padding-top:8px; padding-bottom:0; }
    /* Safe-area for workout screen (topbar hidden) */
    body.inWorkout{ padding-top: var(--safe-top); }


    /* Global iOS-like topbar (logo + title + user + logout)
       - Sticky at the top
       - Adds safe-area padding so it never goes under the notch/status bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      position: relative;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin: 0 0 12px;
      padding: calc(10px + var(--safe-top)) 12px 10px;
      border-radius: 22px;
      background: rgba(18,26,41,.72);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .topbar::after{
      content:"";
      position:absolute;
      left:12px; right:12px;
      bottom:-0.5px;
      height:0.5px;
      background: rgba(255,255,255,.10);
      pointer-events:none;
    }
    [data-theme="light"] .topbar{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(10,20,40,.10);
      box-shadow: 0 10px 22px rgba(10,20,40,.10);
    }

    .brandWrap{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 0;
    }
    .appLogo{
      width:42px;
      height:42px;
      border-radius: 14px;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }

    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand .title{font-size:18px; font-weight:800; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}

    .coachSwitch{ display:flex; align-items:center; gap:10px; margin-right:10px; }
    .coachLabel{ font-size:13px; color:var(--text); opacity:.9; }
    .switch{ position:relative; display:inline-block; width:46px; height:26px; }
    .switch input{ opacity:0; width:0; height:0; }
    .slider{ position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
      background: rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.14);
      transition:.2s; border-radius:999px; }
    .slider:before{ position:absolute; content:""; height:20px; width:20px; left:3px; top:50%;
      transform:translateY(-50%); background: rgba(255,255,255,.92); transition:.2s; border-radius:999px; }
    .switch input:checked + .slider{ background: rgba(59,130,246,.55); border-color: rgba(59,130,246,.65); }
    .switch input:checked + .slider:before{ transform:translate(20px,-50%); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background:var(--card); box-shadow: var(--shadow);
      font-size:13px; color:var(--muted);
    }
    .pill button{
      border:0; background:transparent; color:var(--text);
      font-size:14px; font-weight:700;
    }

    .card{
      background:var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .stack{display:flex; flex-direction:column; gap:12px}
    .row{display:flex; gap:10px; align-items:center}
    .grow{flex:1}
    .muted{color:var(--muted)}
    .h1{font-size:22px; font-weight:900; margin:0 0 4px}
    .h2{font-size:16px; font-weight:900; margin:0}
    .small{font-size:12px}
    .btn{
      border:0; border-radius: 16px;
      background:var(--btn);
      color:var(--text);
      padding:12px 14px;
      font-weight:800;
      box-shadow: var(--shadow);
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#061224}
    .btn.danger{background:var(--danger)}
    .btn.secondary{background:var(--btn2)}
    .btn.wide{width:100%}
    .btn.icon{width:54px; height:54px; padding:0; border-radius:18px}
    .btn.icon.big{width:64px; height:64px; border-radius:22px}

    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    .sessionItem{display:flex; gap:14px; align-items:center}
    .badge{
      font-size:12px; color:var(--muted);
      background: rgba(255,255,255,.06);
      padding:6px 10px; border-radius:999px;
    }
    [data-theme="light"] .badge{background: rgba(10,20,40,.06)}

    .screen{display:none}
    .screen.active{display:block}

    .loginBox{margin-top:14px}
    input{
      width:100%;
      border:0; outline:none;
      background:var(--btn2);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      font-size:15px;
    }

    .timerBox{
      display:flex; flex-direction:column; gap:10px;
      align-items:center; justify-content:center;
      padding: 14px;
    }
    .phase{
      font-weight:900; letter-spacing:.3px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size:12px;
    }
    [data-theme="light"] .phase{background: rgba(10,20,40,.06)}
    .time{
      font-variant-numeric: tabular-nums;
      font-size: 62px;
      font-weight: 950;
      line-height: 1;
      margin: 2px 0 0;
    }
    .subline{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}

    /* Next exercise overlay (inside GIF card) */
    .nextOverlay{
      position:absolute;
      inset:0;
      display:none;
      z-index: 6;
      overflow:hidden;
      border-radius: 22px;
    }
    .nextOverlay.active{display:block}
    .nextOverlay .nextBg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      filter: grayscale(1) brightness(.55) contrast(.95);
      transform: scale(1);
    }
    .nextOverlay::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.10), rgba(0,0,0,.40));
      pointer-events:none;
    }
    .nextOverlay .nextText{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: min(86%, 520px);
      padding: 18px 18px 16px;
      border-radius: 24px;
      background: rgba(10,18,30,.70);
      border: 1px solid rgba(120,200,255,.35);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      text-align:center;
      backdrop-filter: blur(6px);
    }
    .nextOverlay .nextTag{
      font-weight:950;
      letter-spacing:.28em;
      font-size:12px;
      color: rgba(140,215,255,.95);
      margin-bottom: 10px;
    }
    .nextOverlay .nextName{
      font-size:20px;
      font-weight:950;
      letter-spacing:-.2px;
      line-height:1.05;
    }
    .nextOverlay .nextLast{
      margin-top: 10px;
      font-size:18px;
      font-weight:850;
      color: rgba(255,255,255,.88);
    }
    .nextOverlay .nextLast:empty{ display:none; }

    /* Workout redesign */
    .srOnly{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
    body.inWorkout .topbar{ display:none; }

    /* ‚úÖ IMPORTANT: plus de double safe-top ici */
    #screenWorkout{ gap:5px; padding-top: 0; padding-bottom: calc(104px + var(--safe-bot)); }

    .workoutHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 4px 2px;
    }
    .workoutBack{ width:48px; height:48px; border-radius:16px; }
    /* iOS-like chevron back icon */
    .chevronLeft{
      position: relative;
      width: 14px;
      height: 24px;
      display:block;
    }
    .chevronLeft::before,
    .chevronLeft::after{
      content:"";
      position:absolute;
      left:6px;
      width:4px;
      height:16px;
      background: currentColor;
      border-radius:4px;
    }
    .chevronLeft::before{
      top:0;
      transform: rotate(45deg);
    }
    .chevronLeft::after{
      bottom:0;
      transform: rotate(-45deg);
    }
    /* Center the chevron in the square button */
    .workoutBack{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }

    .workoutHeaderCenter{ flex:1; text-align:center; line-height:1.05; }
    .workoutTitle{ font-size:26px; font-weight:950; letter-spacing:-.3px; }
    .workoutSub{ margin-top:4px; font-size:14px; color:var(--muted); }
    .workoutHeaderRight{ width:56px; display:flex; justify-content:flex-end; }

    .workoutChips{ display:flex; justify-content:center; gap:8px; margin-top:2px; margin-bottom:0; }
    .chip{
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text); font-size:13px;
    }
    [data-theme="light"] .chip{ background: rgba(10,20,40,.06); border-color: rgba(10,20,40,.10); }
    .chipPhase{ color: #bfe3ff; border-color: rgba(120,210,255,.35); }
    .chipCoach{ color: #bfffd0; border-color: rgba(90,240,140,.35); }
    .chipSoft{ opacity:.95; }

    .cardTight{ padding:10px; border-radius: 24px; }
    .previewCard{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      background: rgba(0,0,0,.15);
      border:1px solid rgba(255,255,255,.08);
    }
    [data-theme="light"] .previewCard{ background: rgba(10,20,40,.04); border-color: rgba(10,20,40,.10); }
    .previewCard img{ width:100%; height: min(280px, 34vh); object-fit:contain; background:#fff; display:block; }

    .infoBtn{
      position:absolute; right:10px; bottom:10px;
      width:38px; height:38px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color:#fff; font-weight:900; font-size:16px;
      display:flex; align-items:center; justify-content:center;
    }
    .infoBtn:active{ transform: scale(.98); }

    .loadBadge{
      position:absolute;
      left:10px;
      bottom:10px;
      z-index:7;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.40);
      color:#fff;
      font-weight:900;
      font-size:14px;
      letter-spacing:-.2px;
      backdrop-filter: blur(6px);
    }
    .loadBadge.hidden{ display:none; }

    .setDots{display:flex; gap:10px; align-items:center; padding: 0; pointer-events:none;}
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.20);
      border:1px solid rgba(255,255,255,.10);
    }
    .dot.current{ background: rgba(80,170,255,.95); border-color: rgba(80,170,255,.65); }
    .dot.done{ background: rgba(80,240,140,.95); border-color: rgba(80,240,140,.55); }

    .infoOverlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.70);
      display:none;
      padding: 12px;
    }
    .infoOverlay.active{ display:flex; }
    .infoInner{
      width:100%;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,20,30,.85);
      padding: 10px;
      display:flex; flex-direction:column;
      gap:8px;
    }
    .infoHdr{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .infoTitle{ font-size:14px; font-weight:950; }
    .infoBody{ color: rgba(255,255,255,.92); font-size:13px; line-height:1.3; white-space:pre-line; }
    .infoClose{ padding: 8px 12px; border-radius: 14px; }

    /* Load input + history in overlay */
    .loadBox{
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .loadRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .loadInput{
      flex:1;
      width:auto;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      border-radius:14px;
      color: var(--text);
      font-size:14px;
    }
    .loadBtn{ padding:10px 12px; border-radius:14px; font-weight:900; }
    .loadHist{ display:flex; flex-wrap:wrap; gap:8px; }
    .loadChip{
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-size:13px;
      font-weight:850;
    }
    .loadChip:active{ transform: scale(.98); }

    .todoCard{}
    .todoHdr{ display:flex; align-items:center; justify-content:space-between; }
    .todoLabel{ font-size:16px; font-weight:950; }
    .todoMain{ margin-top:6px; font-size:32px; font-weight:950; letter-spacing:-.35px; }
    .todoDesc{ margin-top:4px; font-size:13px; }
    .todoChips{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }

    .timerCard .timerBox{ padding: 8px 4px; }
    .timerBoxFlat{ background: transparent; box-shadow:none; padding: 8px 4px; }
    .timerBoxFlat .time{ font-size:56px; } /* ‚úÖ plus petit */
    .timerBoxFlat .subline{ text-align:center; margin-top: 4px; }

    .btnbar{
      position: sticky;
      bottom: 0;
      padding: 12px 0 calc(12px + var(--safe-bot));
      background: linear-gradient(180deg, rgba(0,0,0,0), var(--bg) 42%);
      display:flex; justify-content:center; gap:14px;
    }

    /* Simplified bottom controls (fixed) */
    body.inWorkout .btnbar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 80;
      gap: 14px;
      padding: 16px 16px calc(16px + var(--safe-bot));
      background: linear-gradient(180deg, rgba(0,0,0,0), var(--bg) 42%);
    }
    body.inWorkout .btnbar .ctrlBtn{
      flex: 1;
      height: 56px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      color: rgba(255,255,255,.92);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }
    body.inWorkout .btnbar .ctrlBtn:active{ transform: scale(.97); }
    body.inWorkout .btnbar .ctrlBtn.primary{
      background: linear-gradient(180deg, rgba(22,92,140,.55), rgba(10,42,64,.72));
      border-color: rgba(120,200,255,.18);
    }
    body.inWorkout .btnbar #btnPrev,
    body.inWorkout .btnbar #btnNext{
      font-weight: 800;
      letter-spacing: -4px;
    }

    /* --- Workout: bordures + spacing 5px + largeur coh√©rente --- */
    body.inWorkout .card.cardTight{ width:100%; margin:0 0 5px 0; }
    body.inWorkout .timerCard{ margin-bottom:0 !important; }
    body.inWorkout .previewCard,
    body.inWorkout .todoCard,
    body.inWorkout .timerCard{
      border: 1px solid rgba(255,255,255,.10);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.03),
        0 10px 28px rgba(0,0,0,.35);
    }
    [data-theme="light"] body.inWorkout .previewCard,
    [data-theme="light"] body.inWorkout .todoCard,
    [data-theme="light"] body.inWorkout .timerCard{
      border-color: rgba(10,20,40,.10);
      box-shadow:
        inset 0 0 0 1px rgba(10,20,40,.03),
        0 10px 28px rgba(10,20,40,.12);
    }
    body.inWorkout #screenWorkout{ padding-top: 0 !important; }

  
    /* Settings modal */
    .modal.hidden{display:none}
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center;
      padding: calc(var(--safe-top) + 12px) 14px calc(var(--safe-bot) + 14px);
      z-index: 9999;
    }
    .modal-content{
      width:min(520px, 100%);
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px 14px 10px;
      border: 1px solid rgba(255,255,255,.06);
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .setting-row{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
      padding: 12px 6px;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:42px;
      border-radius: 14px;
      border: 0;
      background: var(--btn);
      color: var(--text);
      box-shadow: none;
      font-size: 18px;
    }


    /* ===== Historique ===== */
    .historyFilters{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
    }
    .hchip{
      border: 1px solid rgba(255,255,255,.14);
      background: transparent;
      color: inherit;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 16px;
      white-space: nowrap;
      opacity: .85;
    }
    [data-theme="light"] .hchip{
      border-color: rgba(10,20,40,.14);
    }
    .hchip.active{
      opacity: 1;
      border-color: rgba(255,255,255,.35);
    }
    [data-theme="light"] .hchip.active{
      border-color: rgba(10,20,40,.28);
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpiCard{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 12px;
      background: rgba(255,255,255,.04);
    }
    [data-theme="light"] .kpiCard{
      border-color: rgba(10,20,40,.10);
      background: rgba(10,20,40,.03);
    }
    .kpiLabel{ font-size: 13px; opacity:.75; }
    .kpiValue{ font-size: 24px; font-weight: 900; margin-top: 6px; letter-spacing:-.2px; }
    .kpiSub{ font-size: 13px; opacity:.7; margin-top: 2px; }

    .charts{
      display:grid;
      gap:10px;
    }
    .chartCard{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 12px;
      background: rgba(255,255,255,.04);
    }
    [data-theme="light"] .chartCard{
      border-color: rgba(10,20,40,.10);
      background: rgba(10,20,40,.03);
    }
    .chartTitle{ font-size: 13px; opacity:.8; margin-bottom: 8px; }

    .historyListHeader{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:14px;
    }
    .dangerTextBtn{
      background: transparent;
      border: none;
      color: var(--danger);
      font-size: 13px;
      font-weight: 800;
      padding: 8px 10px;
      border-radius: 12px;
    }
    .dangerTextBtn:active{ transform: translateY(1px); }

    .historyList{
      display:flex;
      flex-direction: column;
      gap:10px;
    }
    .historyItem{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 12px;
      background: rgba(255,255,255,.03);
    }
    [data-theme="light"] .historyItem{
      border-color: rgba(10,20,40,.10);
      background: rgba(10,20,40,.02);
    }
    .historyItemTop{
      display:flex;
      justify-content: space-between;
      gap:10px;
      align-items: baseline;
    }
    .historyName{ font-weight: 950; letter-spacing:-.2px; }
    .historyMeta{ opacity: .75; font-size: 13px; }
    .historyLine{ margin-top: 6px; opacity: .90; font-size: 13px; }


    .finishBar{ margin-top: 10px; }
    /* Slide sections on home */
    .homeSection{
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px);
      transition: max-height 260ms ease, opacity 220ms ease, transform 220ms ease;
    }
    .homeSection.open{
      opacity: 1;
      transform: translateY(0);
    }

    .historyDelBtn{
      background: transparent;
      border: none;
      color: var(--danger);
      font-size: 16px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 12px;
    }
    .historyDelBtn:active{ transform: translateY(1px); }
    /* Icones (sans emojis) */
    .icoHistory{
      width: 18px;
      height: 18px;
      display:inline-block;
      position: relative;
      margin-right: 10px;
      border: 2px solid currentColor;
      border-radius: 6px;
      opacity: .9;
      flex: 0 0 auto;
    }
    .icoHistory::before{
      content:"";
      position:absolute;
      left:4px; right:4px; top:4px; bottom:4px;
      border-top: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      opacity: .8;
    }
    .icoHistory::after{
      content:"";
      position:absolute;
      top:4px; bottom:4px;
      left:50%;
      width:0;
      border-left: 2px solid currentColor;
      transform: translateX(-1px);
      opacity: .8;
    }



    /* ===== TROPH√âES ===== */
    .trophySection{
      margin-top: 12px;
      padding: 12px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    [data-theme="light"] .trophySection{
      border-color: rgba(10,20,40,.10);
      background: rgba(10,20,40,.03);
    }
    .trophyHdr{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .trophyHdr .trophyTitle{
      font-size: 14px;
      font-weight: 950;
      margin: 0;
      letter-spacing: .2px;
      opacity: .92;
    }
    .trophyHdr .trophyCount{
      font-size: 12px;
      opacity: .75;
      font-weight: 800;
      white-space: nowrap;
    }
    .trophyGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .trophyBadge{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      padding:10px 8px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      user-select:none;
    }
    [data-theme="light"] .trophyBadge{
      border-color: rgba(10,20,40,.10);
      background: rgba(10,20,40,.02);
    }
    .trophyBadge img{
      width: 56px;
      height: 56px;
      object-fit: contain;
      display:block;
    }
    .trophyBadge .trophyLbl{
      font-size: 11px;
      line-height: 1.1;
      text-align:center;
      opacity:.92;
    }
    .trophyBadge.locked{ opacity:.45; }
    .trophyBadge.locked img{ filter: grayscale(1); }

    /* ===== POPUP TROPH√âE (persistante) ===== */
    .trophyModal.hidden{ display:none; }
    .trophyModal{
      position:fixed;
      inset:0;
      z-index: 10000;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--safe-top) + 16px) 16px calc(var(--safe-bot) + 16px);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    .trophyModalCard{
      width: min(460px, 100%);
      border-radius: 26px;
      background: rgba(18,26,41,.96);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 60px rgba(0,0,0,.50);
      padding: 16px 16px 14px;
      position: relative;
    }
    [data-theme="light"] .trophyModalCard{
      background: rgba(255,255,255,.96);
      border-color: rgba(10,20,40,.14);
      box-shadow: 0 18px 60px rgba(10,20,40,.20);
    }
    .trophyModalClose{
      position:absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 0;
      background: rgba(255,255,255,.10);
      color: var(--text);
      font-weight: 950;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    [data-theme="light"] .trophyModalClose{ background: rgba(10,20,40,.06); }
    .trophyModalTop{
      display:flex;
      gap:14px;
      align-items:center;
      padding-right: 44px;
    }
    .trophyModalTop img{
      width: 78px;
      height: 78px;
      object-fit: contain;
      flex: 0 0 auto;
    }
    .trophyModalTxt{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .trophyModalTxt .mini{
      font-size: 12px;
      opacity: .75;
      font-weight: 850;
      letter-spacing: .2px;
    }
    .trophyModalTxt .big{
      font-size: 18px;
      font-weight: 950;
      letter-spacing: -.2px;
      line-height: 1.05;
    }
    .trophyModalTxt .desc{
      margin-top: 4px;
      font-size: 13px;
      opacity: .88;
      line-height: 1.35;
      white-space: pre-line;
    }
    .trophyModalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 14px;
    }
    .trophyModalActions .btn{ box-shadow:none; }
    .trophyModalActions .btn.secondary{ background: rgba(255,255,255,.08); }


    /* ===== TROPHY MODAL LARGE IMAGE ===== */
    .trophyModalTop{
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding-right: 0;
    }
    .trophyModalTop img{
      width: 140px;
      height: 140px;
      margin-bottom: 8px;
    }
    .trophyModalTxt{
      align-items: center;
    }
    .trophyModalTxt .big{
      font-size: 20px;
    }
    .trophyModalTxt .desc{
      font-size: 14px;
    }


    /* ===== AUTH (Login/Signup) ===== */
    .authTabs{ display:flex; gap:10px; margin-top:12px; }
    .authTab{
      flex:1;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 700;
    }
    .authTab.active{
      background: linear-gradient(180deg, rgba(74,161,255,.30), rgba(74,161,255,.10));
      border-color: rgba(74,161,255,.35);
    }

/* =========================
   B2.0-2-SAFE ‚Äî Custom session editor styles
========================= */
.csList{ display:flex; flex-direction:column; gap:8px; margin:8px 0; }
.csRow{ display:flex; gap:8px; align-items:center; }
.csRow .input{ flex: 1; }
.csRow .mini{ width: 92px; }
.csRow .danger{ min-width:44px; }

</style>

  <!-- Favicon -->
  <link rel="icon" href="images/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="images/icon-192.png">

</head>

<body>
  <div class="app">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brandWrap">
        <img class="appLogo" src="./images/icon-192.png" alt="EliteTraining" />
        <div class="brand">
          <div class="title" id="brandTitle">EliteTraining</div>
          <div class="sub" id="userLine">Non connect√©</div>
        </div>
      </div>
      <div class="pill" id="pillAuth">
        <span id="pillStatus">üîí</span>
<button id="btnLogout" style="display:none">D√©connexion</button>
      </div>
    </div>

    <!-- LOGIN -->
    <section class="screen active" id="screenLogin">
      <div class="card loginBox">
        <div class="h1">Connexion</div>
        <div class="muted small">Charge automatiquement le pack de s√©ances via Firestore (Option B).</div>
        <div style="height:12px"></div>
        <div class="stack">
          <div class="authTabs" role="tablist" aria-label="Connexion ou cr√©ation de compte">
            <button type="button" class="authTab active" id="tabLogin" role="tab" aria-selected="true">Se connecter</button>
            <button type="button" class="authTab" id="tabSignup" role="tab" aria-selected="false">Cr√©er un compte</button>
          </div>

          <input id="signupName" type="text" autocomplete="given-name" placeholder="Pr√©nom" style="display:none" />

          <input id="loginEmail" type="email" autocomplete="username" placeholder="Email" />
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="Mot de passe" />

          <button class="btn primary wide" id="btnLogin">Se connecter</button>
          <button class="btn primary wide" id="btnSignup" style="display:none">Cr√©er le compte</button>

          <div class="muted small" id="loginMsg"></div>
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section class="screen" id="screenHome">
      <div class="card">
        <div class="row">
          <div class="grow">
            <div class="h1">S√©ances</div>
            <div class="muted small">Choisis une s√©ance. Le mode coach est actif par d√©faut.</div>
          </div>
          <button id="btnSettings" class="icon-btn" aria-label="R√©glages" title="R√©glages">‚öôÔ∏è</button>
        </div>

        <div style="height:12px"></div>
        <div class="grid" id="sessionList"></div>
      </div>

      <div style="height:12px"></div>

      <div class="card" id="legacySettingsCard" style="display:none">
        <div class="row">
          <div class="grow">
            <div class="h2">R√©glages</div>
            <div class="muted small">Sauvegard√©s par utilisateur.</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <button class="btn wide" id="btnCoachToggle">üéß Coach vocal : ON</button>
        </div>
      </div>
    

      <div style="height:12px"></div>

      <div class="card">
        <div class="row">
          <div class="grow">
            <div class="h2">Historique</div>
            <div class="muted small">Stats + s√©ances pass√©es (local).</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <button class="btn wide" id="btnHistory"><span class="icoHistory" aria-hidden="true"></span>Historique & r√©ussites</button>
        </div>
      </div>

    </section>

    
    <!-- HISTORY -->
    <section class="screen" id="screenHistory">
      <div class="card">
        <div class="row">
          <div class="grow">
            <div class="h1">Historique</div>
            <div class="muted small">Tes derni√®res s√©ances et quelques stats (stock√©es en local).</div>
          </div>
          <button id="btnBackFromHistory" class="btn secondary icon" aria-label="Retour" title="Retour">‚Üê</button>
        </div>

        <div style="height:12px"></div>

        <div class="historyFilters" id="historyFilters">
          <button class="hchip active" data-range="7">7j</button>
          <button class="hchip" data-range="30">30j</button>
          <button class="hchip" data-range="90">90j</button>
          <button class="hchip" data-range="365">1 an</button>
        </div>

        <div style="height:10px"></div>

        <div class="kpiGrid">
          <div class="kpiCard">
            <div class="kpiLabel">S√©ances</div>
            <div class="kpiValue" id="kpiWorkouts">‚Äî</div>
            <div class="kpiSub" id="kpiWorkoutsSub">sur la p√©riode</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">Temps total</div>
            <div class="kpiValue" id="kpiTime">‚Äî</div>
            <div class="kpiSub">estim√©</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">S√©ries</div>
            <div class="kpiValue" id="kpiSets">‚Äî</div>
            <div class="kpiSub">total</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">Streak</div>
            <div class="kpiValue" id="kpiStreak">‚Äî</div>
            <div class="kpiSub">semaines</div>
          </div>
        </div>

        <!-- TROPH√âES -->
        <div class="trophySection" id="trophySection" style="display:none;">
          <div class="trophyHdr">
            <h3 class="trophyTitle">Troph√©es</h3>
            <div class="trophyCount" id="trophyCount">0/9</div>
          </div>
          <div class="trophyGrid" id="trophyGrid"></div>
        </div>

        <div style="height:12px"></div>
        <div style="height:12px"></div>

        <div style="height:14px"></div>

        <div class="historyListHeader">
          <div class="h2" style="margin:0">Derni√®res s√©ances</div>
          <button class="dangerTextBtn" id="btnClearHistory">Tout effacer</button>
        </div>

        <div style="height:10px"></div>

        <div id="historyList" class="historyList"></div>
      </div>
    </section>

<!-- WORKOUT -->
    <section class="screen" id="screenWorkout">
      <div class="workoutHeader">
        <button class="btn secondary workoutBack" id="btnBackHome" aria-label="Retour"><span class="chevronLeft" aria-hidden="true"></span></button>

        <div class="workoutHeaderCenter">
          <div class="workoutTitle" id="workoutTitle">‚Äî</div>
          <div class="workoutSub" id="workoutSubtitle">Exercice</div>
        </div>

        <div class="workoutHeaderRight">
          <label class="switch" aria-label="Mode coach">
            <input type="checkbox" id="coachSwitch2" />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="workoutChips">
        <div class="chip chipPhase" id="chipPhase">Travail</div>
        <div class="chip chipSeries" id="chipSeries">S√©rie 1/1</div>
        <div class="chip chipCoach" id="chipCoach">Coach : ON</div>
      </div>

      <div class="card cardTight">
        <div class="previewCard" id="previewCard">
          <img id="exoImg" alt="Exercice" />
          <div class="loadBadge hidden" id="loadBadge">‚Äî</div>

          <button class="infoBtn" id="btnInfo" aria-label="Infos">i</button>

          <div class="infoOverlay" id="infoOverlay" aria-hidden="true">
            <div class="infoInner">
              <div class="infoHdr">
                <div class="infoTitle">Conseils</div>
                <button class="btn secondary infoClose" id="btnInfoClose" aria-label="Fermer">‚úï</button>
              </div>
              <div class="infoBody" id="infoBody">‚Äî</div>

              <div class="loadBox">
                <div class="loadRow">
                  <input class="loadInput" id="loadInput" placeholder="Charge (ex: 2x16, 80kg‚Ä¶)" />
                  <button class="btn secondary loadBtn" id="btnLoadSave">OK</button>
                </div>
                <div class="loadHist" id="loadHist"></div>
              </div>

            </div>
          </div>

          <div class="nextOverlay" id="overlayNext" aria-hidden="true">
            <img class="nextBg" id="nextImg" alt="Exercice suivant" />
            <div class="nextText">
              <div class="nextTag">EXERCICE SUIVANT</div>
              <div class="nextName" id="nextName">‚Äî</div>
              <div class="nextLast" id="nextLast"></div>
            </div>
          </div>

        </div>
      </div>

      <div class="card cardTight todoCard">
        <div class="todoHdr">
          <div class="todoLabel">√Ä faire</div>
          <div class="setDots" id="setDots" aria-label="Progression s√©ries"></div>
        </div>
        <div class="todoMain" id="todoMain">‚Äî</div>
        <div class="todoDesc muted" id="todoDesc">‚Äî</div>

        <div class="todoChips">
          <div class="chip chipSoft" id="chipMuscle">‚Äî</div>
          <div class="chip chipSoft" id="chipRest">Repos: ‚Äî</div>
        </div>

        <span class="srOnly" id="kpiReps">‚Äî</span>
        <span class="srOnly" id="kpiRest">‚Äî</span>
        <span class="srOnly" id="kpiLast">‚Äî</span>
        <span class="srOnly" id="exoDesc">‚Äî</span>
      </div>

      <div class="card cardTight timerCard" id="timerCard">
        <div class="timerBox timerBoxFlat">
          <div class="time" id="timeText">00:00</div>
          <!-- ‚úÖ phaseHint supprim√© (redondant) -->
        </div>
      </div>

      <div class="finishBar hidden" id="finishBar" style="display:none;">
        <button class="btn wide" id="btnFinishHome" aria-label="Retour accueil"><span class="chevronLeft" aria-hidden="true"></span>&nbsp;Retour accueil</button>
      </div>


      <div class="btnbar">
        <button class="ctrlBtn" id="btnPrev" title="Pr√©c√©dent" aria-label="Pr√©c√©dent">‚óÄ‚óÄ</button>
        <button class="ctrlBtn primary" id="btnPlayPause" title="Start / Pause" aria-label="Start / Pause">‚ñ∂Ô∏é</button>
        <button class="ctrlBtn" id="btnNext" title="Suivant" aria-label="Suivant">‚ñ∂‚ñ∂</button>
      </div>
    </section>
  </div>

  <script src="./images.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
   import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAPICbQrWgARovGaebUYYP-WwohxQAYtuw",
      authDomain: "programme-force.firebaseapp.com",
      projectId: "programme-force",
      storageBucket: "programme-force.firebasestorage.app",
      messagingSenderId: "1070910165788",
      appId: "1:1070910165788:web:8212aec95671abfbdb60d9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    const APP_TITLE = "EliteTraining";
    const ELITE_LAST_EMAIL = "elite_last_email";

    /***********************
     * Fin de s√©ance (al√©atoire)
     ***********************/
    const FIN_GIFS = [
      "images/fin_seance.gif",
      "images/fin_seance_2.gif",
      "images/fin_seance_3.gif",
      "images/fin_seance_4.gif",
      "images/fin_seance_5.gif",
      "images/fin_seance_6.gif",
      "images/fin_seance_7.gif",
      "images/fin_seance_8.gif",
      // Ajoute d'autres GIFs ici, ex:
      // "images/fin_seance_2.gif",
      // "images/fin_seance_3.gif",
    ];

    const FIN_PHRASES = [
  "No pain, no gain !",
  "Tu es sur le chemin pour devenir la meilleure version de toi-m√™me.",
  "Aujourd‚Äôhui tu as gagn√© contre le canap√©.",
  "Si c‚Äô√©tait facile, tout le monde le ferait.",
  "La discipline bat la motivation. Tousemaines.",
  "Bravo. Tu peux maintenant marcher comme un robot avec fiert√©.",
  "Chaque r√©p√©tition te rapproche de ton objectif.",
  "Train insane or remain the same.",
  "Les excuses ne br√ªlent pas de calories.",
  "Encore une s√©ance de plus dans la banque des gains."
      // Ajoute d'autres phrases ici, ex:
      // "Bravo ! Petit √©tirement et r√©cup√©ration, tu l'as m√©rit√©.",
      // "Excellent travail üí™ Pense √† bien respirer et √† boire un verre d'eau.",
    ];

    function pickRandom(arr){
      if(!Array.isArray(arr) || arr.length === 0) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    let topbarUserText = "Non connect√©";
    const screens = { login:$("screenLogin"), home:$("screenHome"), history:$("screenHistory"), workout:$("screenWorkout") };

    let currentUser = null;
    function ukey(suffix){
      const uid = currentUser?.uid || "anon";
      return `${uid}__${suffix}`;
    }


    function migrateTrophyStorage(uid){
      // Merge older keys into the current keys (non-destructive).
      // This prevents losing trophies when we change suffix names between versions.
      const newStateKey = `${uid}__trophies_v1`;
      const newPendingKey = `${uid}__trophies_pending_v1`;

      const legacyStateKeys = [
        `${uid}__coach_trophies_v1`,
        `${uid}__coach_trophies`,
        `${uid}__trophies`,
        `coach_trophies_v1`,
        `coach_trophies`,
        `coach_trophies_v1_${uid}`,
      ];
      const legacyPendingKeys = [
        `${uid}__coach_trophies_pending_v1`,
        `${uid}__coach_trophies_pending`,
        `${uid}__trophies_pending`,
        `coach_trophies_pending_v1`,
        `coach_trophies_pending`,
      ];

      function readObj(key){
        try{
          const v = localStorage.getItem(key);
          if(!v) return null;
          const o = JSON.parse(v);
          return (o && typeof o === "object" && !Array.isArray(o)) ? o : null;
        }catch(e){ return null; }
      }
      function readArr(key){
        try{
          const v = localStorage.getItem(key);
          if(!v) return null;
          const a = JSON.parse(v);
          return Array.isArray(a) ? a : null;
        }catch(e){ return null; }
      }

      // State
      let state = readObj(newStateKey) || {};
      legacyStateKeys.forEach(k=>{
        const o = readObj(k);
        if(o){
          state = { ...o, ...state }; // keep any newer flags
        }
      });
      localStorage.setItem(newStateKey, JSON.stringify(state));

      // Pending
      let pending = readArr(newPendingKey) || [];
      legacyPendingKeys.forEach(k=>{
        const a = readArr(k);
        if(a){
          pending = [...a, ...pending];
        }
      });
      // dedupe
      pending = pending.filter((v,i,a)=>a.indexOf(v)===i);
      localStorage.setItem(newPendingKey, JSON.stringify(pending));
    }

    function showScreen(name){
      Object.values(screens).forEach(s=>s.classList.remove("active"));
      screens[name].classList.add("active");

      const bt = $("brandTitle");
      if(bt) bt.textContent = (name === "workout") ? (curSession?.name || "S√©ance") : APP_TITLE;
      const ul = $("userLine");
      if(ul && name !== "workout") ul.textContent = topbarUserText;

      document.body.classList.toggle("inWorkout", name === "workout");

      const wrap = $("coachSwitchWrap");
      if(wrap) wrap.style.display = "none";
      const lo = $("btnLogout");
      if(lo) lo.style.display = (name === "workout") ? "none" : (currentUser ? "inline-flex" : "none");

      const sb = $("btnSettings");
      if(sb) sb.style.display = (name === "workout" || name === "history") ? "none" : "inline-flex";
    }
    

// Prefill email (UX)
try{
  const last = localStorage.getItem(ELITE_LAST_EMAIL);
  if(last && $("loginEmail")) $("loginEmail").value = last;
}catch(e){}
function setMsg(txt){ $("loginMsg").textContent = txt || ""; }

    const THEME_KEY = "coach_theme";
    function applyTheme(t){
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem(THEME_KEY, t);
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute("content", t==="light" ? "#f5f7fb" : "#0b0f17");
    }
    applyTheme(localStorage.getItem(THEME_KEY) || "dark");

    // --- R√©glages (home only) ---
    (function(){
      const modal = $("settingsModal");
      const openBtn = $("btnSettings");
      const closeBtn = $("closeSettings");
      const themeT = $("themeToggleModal");
      const coachT = $("coachToggleModal");

      function openModal(){
        if(!modal) return;
        // sync switches
        if(themeT) themeT.checked = (document.documentElement.getAttribute("data-theme") === "dark");
        if(coachT) coachT.checked = !!coachMode;
        modal.classList.remove("hidden");
      }
      function closeModal(){
        if(!modal) return;
        modal.classList.add("hidden");
      }

      if(openBtn) openBtn.addEventListener("click", openModal);
      if(closeBtn) closeBtn.addEventListener("click", closeModal);
      if(modal) modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

      if(themeT){
        themeT.addEventListener("change", ()=>{
          applyTheme(themeT.checked ? "dark" : "light");
        });
      }
      if(coachT){
        coachT.addEventListener("change", ()=>{
          coachMode = coachT.checked;
          localStorage.setItem("coachMode", coachMode ? "1" : "0");
        });
      }
    })();


    // ===== Profil utilisateur (Firestore: users/{uid}/profile/main) =====
    (function(){
      const modal = $("profileModal");
      const openBtn = $("openProfileBtn");
      const closeBtn = $("closeProfile");
      const btnSave = $("profileSave");
      const btnReset = $("profileReset");

      const elGoal = $("profileGoal");
      const elLevel = $("profileLevel");
      const elDays = $("profileDays");
      const elMin = $("profileMinutes");
      const elNotes = $("profileNotes");

      function setProfileMsg(t){
        const el = $("profileMsg");
        if(el) el.textContent = t || "";
      }

      function defaults(){
        const email = currentUser?.email || "";
        const baseName = (email.split("@")[0] || "Utilisateur").slice(0, 20);
        return {
          goal: "force",
          level: "intermediaire",
          daysPerWeek: 3,
          sessionMinutes: 30,
          equipment: ["halteres", "banc"],
          constraints: [],
          notes: "",
          preferences: { coachVoice: true, language: "fr", focus: [] },
          displayName: baseName,
          updatedAt: new Date()
        };
      }

      function getChecked(selector){
        return Array.from(document.querySelectorAll(selector))
          .filter(x => x && x.checked)
          .map(x => x.value);
      }
      function setChecked(selector, values){
        const set = new Set(values || []);
        Array.from(document.querySelectorAll(selector)).forEach(x=>{
          if(x) x.checked = set.has(x.value);
        });
      }

      function fillForm(p){
        if(!p) return;
        if(elGoal) elGoal.value = p.goal || "force";
        if(elLevel) elLevel.value = p.level || "intermediaire";
        if(elDays) elDays.value = Number(p.daysPerWeek || 3);
        if(elMin) elMin.value = Number(p.sessionMinutes || 30);
        if(elNotes) elNotes.value = p.notes || "";
        setChecked(".profileEquip", p.equipment || []);
        setChecked(".profileConstraint", p.constraints || []);
      }

      function readForm(){
        const p = defaults();
        p.goal = elGoal ? elGoal.value : p.goal;
        p.level = elLevel ? elLevel.value : p.level;
        p.daysPerWeek = elDays ? Math.max(1, Math.min(7, Number(elDays.value || p.daysPerWeek))) : p.daysPerWeek;
        p.sessionMinutes = elMin ? Math.max(10, Math.min(120, Number(elMin.value || p.sessionMinutes))) : p.sessionMinutes;
        p.notes = elNotes ? (elNotes.value || "") : "";
        p.equipment = getChecked(".profileEquip");
        p.constraints = getChecked(".profileConstraint");
        p.updatedAt = new Date();
        return p;
      }

      async function loadProfile(){
        if(!currentUser) throw new Error("Non connect√©");
        const ref = doc(db, "users", currentUser.uid, "profile", "main");
        const snap = await getDoc(ref);
        if(!snap.exists()){
          const def = defaults();
          await setDoc(ref, def, { merge: true });
          return def;
        }
        return snap.data();
      }

      async function saveProfile(){
        if(!currentUser) throw new Error("Non connect√©");
        const ref = doc(db, "users", currentUser.uid, "profile", "main");
        const data = readForm();
        await setDoc(ref, data, { merge: true });
      }

      function openModal(){
        if(!modal) return;
        setProfileMsg("Chargement...");
        modal.classList.remove("hidden");
        (async ()=>{
          try{
            const p = await loadProfile();
            fillForm(p);
            setProfileMsg(" ");
          }catch(e){
            setProfileMsg("Erreur : " + (e?.message || e));
          }
        })();
      }
      function closeModal(){
        if(!modal) return;
        modal.classList.add("hidden");
      }

      if(openBtn) openBtn.addEventListener("click", ()=>{
        // ferme r√©glages si ouvert
        try{ $("settingsModal")?.classList.add("hidden"); }catch(e){}
        openModal();
      });
      if(closeBtn) closeBtn.addEventListener("click", closeModal);
      if(modal) modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

      if(btnSave) btnSave.addEventListener("click", async ()=>{
        try{
          setProfileMsg("Enregistrement...");
          await saveProfile();
          setProfileMsg("Enregistr√© ‚úÖ");
        }catch(e){
          setProfileMsg("Erreur : " + (e?.message || e));
        }
      });

      if(btnReset) btnReset.addEventListener("click", ()=>{
        fillForm(defaults());
        setProfileMsg("R√©initialis√© (pense √† Enregistrer).");
      });
    })();


    let coachMode = (localStorage.getItem("coachMode") === "0") ? false : true;
    let __endSpoken = false;
    function speak(text){
      try{
        if(!coachMode) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "fr-FR";
        u.rate = 1.0;
        speechSynthesis.speak(u);
      }catch(e){}
    }
    function beep(freq=880, ms=90){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        o.connect(g); g.connect(ctx.destination);
        g.gain.value = 0.06;
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, ms);
      }catch(e){}
    }

    function loadCoachMode(){
      const v = localStorage.getItem(ukey("coach_mode"));
      coachMode = (v === null) ? true : (v === "1");
      const sw = $("coachSwitch"); if(sw) sw.checked = coachMode;
      const sw2 = $("coachSwitch2"); if(sw2) sw2.checked = coachMode;
      $("btnCoachToggle").textContent = coachMode ? "üéß Coach vocal : ON" : "üéß Coach vocal : OFF";
      const cc = $("chipCoach"); if(cc) cc.textContent = coachMode ? "Coach : ON" : "Coach : OFF";
    }
    function toggleCoachMode(){
      coachMode = !coachMode;
      localStorage.setItem(ukey("coach_mode"), coachMode ? "1" : "0");
      const sw = $("coachSwitch"); if(sw) sw.checked = coachMode;
      const sw2 = $("coachSwitch2"); if(sw2) sw2.checked = coachMode;
      $("btnCoachToggle").textContent = coachMode ? "üéß Coach vocal : ON" : "üéß Coach vocal : OFF";
      const cc = $("chipCoach"); if(cc) cc.textContent = coachMode ? "Coach : ON" : "Coach : OFF";
    }
    $("btnCoachToggle").addEventListener("click", toggleCoachMode);

    $("coachSwitch")?.addEventListener("change", (e)=>{
      coachMode = !!e.target.checked;
      localStorage.setItem(ukey("coach_mode"), coachMode ? "1" : "0");
      const sw2 = $("coachSwitch2"); if(sw2) sw2.checked = coachMode;
      $("btnCoachToggle").textContent = coachMode ? "üéß Coach vocal : ON" : "üéß Coach vocal : OFF";
      const cc = $("chipCoach"); if(cc) cc.textContent = coachMode ? "Coach : ON" : "Coach : OFF";
    });

    $("coachSwitch2")?.addEventListener("change", (e)=>{
      coachMode = !!e.target.checked;
      localStorage.setItem(ukey("coach_mode"), coachMode ? "1" : "0");
      const sw1 = $("coachSwitch"); if(sw1) sw1.checked = coachMode;
      $("btnCoachToggle").textContent = coachMode ? "üéß Coach vocal : ON" : "üéß Coach vocal : OFF";
      const cc = $("chipCoach"); if(cc) cc.textContent = coachMode ? "Coach : ON" : "Coach : OFF";
    });

    function loadScriptOnce(src){
      return new Promise((resolve, reject)=>{
        if(document.querySelector(`script[data-dyn="${src}"]`)) return resolve();
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.setAttribute("data-dyn", src);
        s.onload = ()=>resolve();
        s.onerror = ()=>reject(new Error("Impossible de charger: " + src));
        document.head.appendChild(s);
      });
    }

    async function getUserConfig(uid){
  const ref = doc(db, `users/${uid}/profile/config`);
  const snap = await getDoc(ref);

  // Auto-setup: if the user has no config yet, create a safe default pack.
  // This prevents "Config Firestore manquante" on first signup / first login.
  if(!snap.exists()){
    const email = currentUser?.email || "";
    const displayName = (currentUser?.displayName && String(currentUser.displayName).trim())
      ? String(currentUser.displayName).trim()
      : (email.includes("@") ? email.split("@")[0] : (email || "Utilisateur"));
    const defaultCfg = {
      displayName,
      sessionsFile: "./sessions.js",
      sessionsVar: "SESSIONS",
    };
    await setDoc(ref, defaultCfg, { merge: true });
    return defaultCfg;
  }

  const cfg = snap.data() || {};
  // Hardening: fill missing fields with defaults (non-breaking).
  if(!cfg.sessionsFile || !cfg.sessionsVar){
    const email = currentUser?.email || "";
    const displayName = cfg.displayName
      || ((currentUser?.displayName && String(currentUser.displayName).trim()) ? String(currentUser.displayName).trim() : "")
      || (email.includes("@") ? email.split("@")[0] : (email || "Utilisateur"));
    const patched = {
      displayName,
      sessionsFile: cfg.sessionsFile || "./sessions.js",
      sessionsVar: cfg.sessionsVar || "SESSIONS",
    };
    await setDoc(ref, patched, { merge: true });
    return patched;
  }

  return cfg;
}

    window.SESSIONS = null;

    async function loadUserSessions(uid){
      const cfg = await getUserConfig(uid);
      const file = cfg.sessionsFile;
      const varName = cfg.sessionsVar;

      if(!file || !varName) throw new Error("Config invalide: sessionsFile/sessionsVar.");
      await loadScriptOnce(file);

      const obj = window[varName];
      if(!obj) throw new Error(`Variable sessions introuvable: window["${varName}"]`);

      window.SESSIONS = obj;
      topbarUserText = cfg.displayName || currentUser?.email || "Connect√©";
      if(!screens.workout.classList.contains("active")) $("userLine").textContent = topbarUserText;
    }

    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

    function renderHome(){
      const sessions = window.SESSIONS || {};
      const allKeys = Object.keys(sessions);

      const host = $("sessionList");
      host.innerHTML = "";

/* =========================
   B1-SAFE ‚Äî HOME: Section s√©par√©e "Mes s√©ances" + "S√©ances compl√®tes"
   √Ä COLLER JUSTE APR√àS : host.innerHTML = "";
========================= */

const allEntries = Object.entries(sessions);

// custom = cl√©s CUSTOM_ (ou source:"custom" si pr√©sent)
const customEntries = allEntries.filter(([k,v]) => k.startsWith("CUSTOM_") || (v && v.source === "custom"));
const coreEntries   = allEntries.filter(([k,v]) => !k.startsWith("CUSTOM_") && !(v && v.source === "custom"));

function addSectionTitle(title){
  const h = document.createElement("div");
  h.style.cssText = "margin:10px 4px 8px; font-weight:800; opacity:.95;";
  h.textContent = title;
  host.appendChild(h);
}

/* ===== FIN B1-SAFE (partie 1/2) ===== */


      if(allKeys.length === 0){
        host.innerHTML = `<div class="muted small">Aucune s√©ance trouv√©e dans ton pack.</div>`;
        return;
      }

      // --- Groupes home (app pro) ---
      // 1) S√©ances compl√®tes : A1,B1,C1,D1,A2,B2,...
      // 2) Running : √©chauffements course (ex: RUN_WU)
      // (Pr√©vu plus tard) Hockey : cl√©s type HOC_* ou nom contenant "hockey"
      const isRunning = (k, s) => /^RUN[_-]/i.test(k) || /course|running/i.test(String(s?.name||""));
      const isHockey  = (k, s) => /^HOC[_-]/i.test(k) || /hockey/i.test(String(s?.name||""));
/* =========================
   B1-SAFE ‚Äî Groupe "Mes s√©ances" (custom)
   √Ä COLLER JUSTE AVANT : const complete = [];
========================= */
	const isCustom = (k, s) => k.startsWith("CUSTOM_") || (s && s.source === "custom");
	const custom = [];
/* ===== FIN B1-SAFE ===== */
      const complete = [];
      const running = [];
      const hockey = [];

/* =========================
   B1-SAFE ‚Äî R√©partition avec custom en premier
========================= */
allKeys.forEach((k)=>{
  const s = sessions[k];

  if(isCustom(k, s)) custom.push(k);
  else if(isHockey(k, s)) hockey.push(k);
  else if(isRunning(k, s)) running.push(k);
  else complete.push(k);
});
/* ===== FIN B1-SAFE ===== */

      const letterOrder = { A:0, B:1, C:2, D:3 };
      function sortComplete(a, b){
        const ma = String(a).match(/^([A-Z])([0-9]+)$/i);
        const mb = String(b).match(/^([A-Z])([0-9]+)$/i);
        if(ma && mb){
          const la = ma[1].toUpperCase(), lb = mb[1].toUpperCase();
          const na = parseInt(ma[2], 10), nb = parseInt(mb[2], 10);
          if(na !== nb) return na - nb; // 1 puis 2 puis 3...
          const oa = (la in letterOrder) ? letterOrder[la] : 99;
          const ob = (lb in letterOrder) ? letterOrder[lb] : 99;
          if(oa !== ob) return oa - ob; // A,B,C,D
          return la.localeCompare(lb);
        }
        // fallback alpha
        return String(a).localeCompare(String(b));
      }

      complete.sort(sortComplete);
      running.sort((a,b)=>String(a).localeCompare(String(b)));
      hockey.sort((a,b)=>String(a).localeCompare(String(b)));

      function addSection(title, keys, opts){
        const options = opts || {};
        const sectionId = options.id || title.toLowerCase().replace(/[^a-z0-9]+/g, "_");
        const defaultOpen = (options.defaultOpen !== undefined) ? options.defaultOpen : true;

        // Header row
        const header = document.createElement("div");
        header.style.margin = "14px 2px 8px";
        header.style.display = "flex";
        header.style.alignItems = "center";
        header.style.justifyContent = "space-between";
        header.style.gap = "10px";

        const t = document.createElement("div");
        t.className = "h2";
        t.style.fontSize = "16px";
        t.style.cursor = "pointer";
        t.textContent = `${title}`;

        const btn = document.createElement("button");
        btn.className = "btn";
        btn.style.padding = "8px 10px";
        btn.style.minWidth = "44px";
        btn.setAttribute("aria-expanded", defaultOpen ? "true" : "false");
        btn.textContent = String(keys.length);

      /* =========================
   B2.0-SAFE ‚Äî Header actions (count + add button for custom)
   REMPLACE : header.appendChild(t); header.appendChild(btn); host.appendChild(header);
========================= */

const actions = document.createElement("div");
actions.style.display = "flex";
actions.style.alignItems = "center";
actions.style.gap = "8px";

// Bouton ‚ûï uniquement pour la section "custom"
if(options.id === "custom"){
  const addBtn = document.createElement("button");
  addBtn.className = "btn";
  addBtn.style.padding = "8px 10px";
  addBtn.style.minWidth = "44px";
  addBtn.title = "Cr√©er une s√©ance";
  addBtn.textContent = "‚ûï";
  addBtn.onclick = () => openCustomSessionEditor(null); // (fonction ajout√©e √† l'√©tape B2.0-2)
  actions.appendChild(addBtn);
}

// Compteur (on garde ton bouton tel quel)
actions.appendChild(btn);

header.appendChild(t);
header.appendChild(actions);
host.appendChild(header);

/* ===== FIN B2.0-SAFE ===== */

        // Container
        const container = document.createElement("div");
        container.dataset.section = sectionId;
        container.className = "homeSection" + (defaultOpen ? " open" : "");
        // max-height is set dynamically for smooth slide
        container.style.maxHeight = defaultOpen ? (container.scrollHeight + "px") : "0px";
        host.appendChild(container);

        const toggle = ()=>{
          const isOpen = container.classList.contains("open");

          if(isOpen){
            // collapse
            container.style.maxHeight = container.scrollHeight + "px";
            // force reflow
            void container.offsetHeight;
            container.style.maxHeight = "0px";
            container.classList.remove("open");
            btn.setAttribute("aria-expanded", "false");
          }else{
            container.classList.add("open");
            container.style.maxHeight = container.scrollHeight + "px";
            btn.setAttribute("aria-expanded", "true");
          }

          btn.textContent = String(keys.length);
        };

        btn.addEventListener("click", toggle);
        t.addEventListener("click", toggle);


        keys.forEach((k)=>addSessionCard(k, container));

        // Update height after cards are inserted
        if(defaultOpen){
          container.style.maxHeight = container.scrollHeight + "px";
        }
      }

      function addSessionCard(k, mount){
        const s = sessions[k];
        const name = s?.name || k;
        const nWarmup = (s?.warmup||[]).length;
        const nCooldown = (s?.cooldown||[]).length;
        const nItems = (s?.items||[]).length;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="sessionItem">
            <div class="grow">
              <div class="h2">${escapeHtml(name)}</div>
              <div class="muted small">${nWarmup} √©chauffement ‚Ä¢ ${nItems} exercices${nCooldown ? ` ‚Ä¢ ${nCooldown} √©tirements` : ""}</div>
            </div>
            <button class="btn primary">D√©marrer</button>
          </div>
        `;
        card.querySelector("button").addEventListener("click", ()=>startSession(k));
        mount.appendChild(card);
      }


      function updateOpenSectionsHeight(){
        host.querySelectorAll(".homeSection.open").forEach(el=>{
          el.style.maxHeight = el.scrollHeight + "px";
        });
      }
      window.addEventListener("resize", ()=>{ updateOpenSectionsHeight(); }, { passive:true });

      // Render
      
/* =========================
   B1-SAFE ‚Äî Render section "Mes s√©ances"
   √Ä COLLER JUSTE AVANT : if(complete.length){ ... }
========================= */
if(custom.length){
  addSection("Mes s√©ances", custom, { id:"custom", defaultOpen:true });
}
/* ===== FIN B1-SAFE ===== */

if(complete.length){
        addSection("S√©ances compl√®tes", complete, { id:"complete", defaultOpen:false });
      }

      if(running.length){
        addSection("Running", running, { id:"running", defaultOpen:false });
      }

      // On ne l'affiche que si tu ajoutes des s√©ances hockey plus tard
      if(hockey.length){
        addSection("Hockey", hockey, { id:"hockey", defaultOpen:false });
      }
    }

    /***********************
     * History (per-user) with date
     ***********************/
    function histKey(exoId){ return ukey(`hist__${exoId}`); }
    function todayISO(){
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    function getLoadHistory(exoId){
      const raw = localStorage.getItem(histKey(exoId));
      if(!raw) return [];
      if(raw[0] !== "["){
        const v = raw.trim();
        return v ? [{ v, d: todayISO() }] : [];
      }
      try{
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        return arr.map(x=>{
          if(typeof x === "string") return { v:x, d: todayISO() };
          if(x && x.v) return { v:String(x.v), d: x.d || todayISO() };
          return null;
        }).filter(Boolean);
      }catch(e){ return []; }
    }
    function saveLoad(exoId, value){
      const v = String(value||"").trim();
      if(!v) return;
      const arr = getLoadHistory(exoId);
      const filtered = arr.filter(x => x.v !== v);
      const entry = { v, d: todayISO() };
      const capped = [entry, ...filtered].slice(0, 12);
      localStorage.setItem(histKey(exoId), JSON.stringify(capped));
    }
    function getLastLoad(exoId){
      const arr = getLoadHistory(exoId);
      return arr[0]?.v || "";
    }

    let currentExoIdForLoad = null;


    function rememberLoadInSession(session, exoId, v){
      try{
        if(!session || !exoId) return;
        const items = session.items || [];
        for(const it of items){
          if(it?.id === exoId || it?.name === exoId){
            it._usedLoad = v;
          }
        }
      }catch(e){}
    }

    function captureCurrentInputToSessionLoads(){
      try{
        if(!currentExoIdForLoad) return;
        const v = ($("loadInput")?.value || "").trim();
        if(!v) return;
        sessionLoadsUsed[currentExoIdForLoad] = v;
        rememberLoadInSession(curSession, currentExoIdForLoad, v);
      }catch(e){}
    }

    function formatDateFR(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      return `${d}.${m}.${y}`;
    }

    function updateLoadBadge(){
      const b = $("loadBadge");
      if(!b) return;
      const v = currentExoIdForLoad ? getLastLoad(currentExoIdForLoad) : "";
      if(v){
        b.textContent = v;
        b.classList.remove("hidden");
      }else{
        b.textContent = "‚Äî";
        b.classList.add("hidden");
      }
    }

    function renderLoadHistory(){
      const host = $("loadHist");
      const input = $("loadInput");
      if(!host) return;
      host.innerHTML = "";

      const arr = currentExoIdForLoad ? getLoadHistory(currentExoIdForLoad) : [];
      if(arr.length === 0) return;

      arr.forEach(item=>{
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "loadChip";
        chip.textContent = `${formatDateFR(item.d)} ‚Äì ${item.v}`;
        chip.addEventListener("click", ()=>{
          if(input) input.value = item.v;
        });
        host.appendChild(chip);
      });
    }

    function saveFromInput(){
      if(!currentExoIdForLoad) return;
      const input = $("loadInput");
      const v = (input?.value || "").trim();
      if(!v) return;
      saveLoad(currentExoIdForLoad, v);
      
      try{ sessionLoadsUsed[currentExoIdForLoad] = v; }catch(e){}
      try{ rememberLoadInSession(curSession, currentExoIdForLoad, v); }catch(e){}
updateLoadBadge();
      renderLoadHistory();
    }

    $("btnLoadSave")?.addEventListener("click", saveFromInput);
    $("loadInput")?.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        saveFromInput();
      }
    });

    
    /***********************
     * Workout History (per-user)
     ***********************/
    function workoutHistKey(){ return ukey("workout_history"); }

    function loadWorkoutHistory(){
      try{
        return JSON.parse(localStorage.getItem(workoutHistKey()) || "[]");
      }catch(e){
        return [];
      }
    }
    function saveWorkoutHistory(arr){
      localStorage.setItem(workoutHistKey(), JSON.stringify(arr));
    }
    /***********************
     * TROPH√âES (per-user)
     ***********************/
    const TROPHY_KEY = ()=> ukey("trophies_v1");
    const TROPHY_PENDING_KEY = ()=> ukey("trophies_pending_v1");

    const TROPHIES = [
{ id:"first_session", iconKey:"trophy_first", label:"Premi√®re s√©ance",
        title:"Premi√®re victoire",
        desc:"Tu viens de terminer ta premi√®re s√©ance.\nLe plus dur, c‚Äô√©tait de commencer.",
        type:"sessions", threshold:1
      },
      { id:"sessions_10", iconKey:"trophy_10", label:"10 s√©ances",
        title:"La r√©gularit√© paie",
        desc:"10 s√©ances compl√©t√©es.\nCe n‚Äôest plus un hasard, c‚Äôest une habitude.",
        type:"sessions", threshold:10
      },
      { id:"sessions_30", iconKey:"trophy_30", label:"30 s√©ances",
        title:"Discipline install√©e",
        desc:"30 s√©ances au compteur.\nTu construis quelque chose de solide.",
        type:"sessions", threshold:30
      },
      { id:"ton_1", iconKey:"trophy_1t", label:"1 tonne",
        title:"Premi√®re tonne",
        desc:"1 000 kg soulev√©s au total.\nBrique apr√®s brique, tu progresses.",
        type:"tonnageKg", threshold:1000
      },
      { id:"ton_10", iconKey:"trophy_10t", label:"10 tonnes",
        title:"Force cumul√©e",
        desc:"10 tonnes d√©plac√©es.\nLa constance fait la diff√©rence.",
        type:"tonnageKg", threshold:10000
      },
{ id:"weeks_3", iconKey:"trophy_weeks_3", label:"3 semaines",
  title:"Le rythme est lanc√©",
  desc:"3 semaines avec au moins une s√©ance.\nLa r√©gularit√© commence √† s‚Äôinstaller.",
  type:"weeks", threshold:3
},
{ id:"weeks_10", iconKey:"trophy_weeks_10", label:"10 semaines",
  title:"Habitude solide",
  desc:"10 semaines actives.\nTu tiens le cap.",
  type:"weeks", threshold:10
},
{ id:"weeks_26", iconKey:"trophy_weeks_26", label:"26 semaines",
  title:"Mi-ann√©e de constance",
  desc:"26 semaines actives.\nLa constance devient ta norme.",
  type:"weeks", threshold:26
},
{ id:"weeks_52", iconKey:"trophy_weeks_52", label:"52 semaines",
  title:"Ann√©e compl√®te",
  desc:"52 semaines actives.\nTu as construit une vraie discipline.",
  type:"weeks", threshold:52
},
    ];

    function loadTrophyState(){
      try{ return JSON.parse(localStorage.getItem(TROPHY_KEY()) || "{}") || {}; }
      catch(e){ return {}; }
    }
    function saveTrophyState(s){
      localStorage.setItem(TROPHY_KEY(), JSON.stringify(s || {}));
    }

    function loadPendingTrophies(){
      try{
        const arr = JSON.parse(localStorage.getItem(TROPHY_PENDING_KEY()) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function savePendingTrophies(ids){
      localStorage.setItem(TROPHY_PENDING_KEY(), JSON.stringify(Array.isArray(ids) ? ids : []));
    }

    function parseLoadToKg(loadStr){
      const s = String(loadStr||"").trim().toLowerCase();
      if(!s) return 0;
      // "2x16" => 32
      let m = s.match(/(\d+(?:\.\d+)?)\s*[x√ó]\s*(\d+(?:\.\d+)?)/);
      if(m){
        const a = parseFloat(m[1]);
        const b = parseFloat(m[2]);
        if(isFinite(a) && isFinite(b)) return a*b;
      }
      // "80kg" or "80" => 80
      m = s.match(/(\d+(?:\.\d+)?)/);
      if(m){
        const v = parseFloat(m[1]);
        return isFinite(v) ? v : 0;
      }
      return 0;
    }

    function parseRepsToNumber(reps){
      const s = String(reps||"").trim();
      // "8-10" -> 8, "12" -> 12
      const m = s.match(/(\d+)/);
      return m ? Math.max(1, parseInt(m[1],10)) : 10;
    }

    function computeSessionTonnageKg(session, usedLoads){
      try{
        const items = session?.items || [];
        let total = 0;
        const map = (usedLoads && typeof usedLoads === "object") ? usedLoads : {};
        items.forEach(e=>{
          const sets = Number(e?.sets || 1);
          const reps = parseRepsToNumber(e?.reps || "");
          const exoId = e?.id || e?.name || "exo";
          // ‚úÖ Priorit√©: charge saisie pendant CETTE s√©ance, sinon derni√®re charge connue
          const loadStr = (e?._usedLoad != null && String(e._usedLoad).trim() !== "") ? e._usedLoad
            : ((map[exoId] != null && String(map[exoId]).trim() !== "") ? map[exoId] : (getLastLoad(exoId) || ""));
          const kg = parseLoadToKg(loadStr);
          if(kg > 0) total += kg * reps * sets;
        });
        return Math.round(total);
      }catch(e){
        return 0;
      }
    }

    function getTrophyProgress(all){
      const sessions = all.length;
      const streakDays = computeStreakFromHistory(all);
      const weeksStreak = computeWeeklyStreakFromHistory(all);
      const tonnageKg = all.reduce((a,x)=>a + (Number(x.tonnageKg||0) || 0), 0);
      return { sessions, streakDays, weeksStreak, tonnageKg };
    }

    function evaluateAndUnlockTrophies(all){
      const state = loadTrophyState();
      const prog = getTrophyProgress(all);

      const newly = [];
      TROPHIES.forEach(t=>{
        if(state[t.id]) return;

        const cur =
          (t.type === "sessions") ? prog.sessions :
          (t.type === "weeks") ? prog.weeksStreak :
          (t.type === "streak") ? prog.streakDays :
          (t.type === "tonnageKg") ? prog.tonnageKg : 0;

        if(cur >= t.threshold){
          state[t.id] = true;
          newly.push(t.id);
        }
      });

      if(newly.length){
        saveTrophyState(state);
        // accumulate pending (avoid duplicates)
        const pending = loadPendingTrophies();
        const merged = [...pending, ...newly].filter((v,i,a)=>a.indexOf(v)===i);
        savePendingTrophies(merged);
      }
      return newly;
    }

    function renderTrophiesSection(all){
      const section = $("trophySection");
      const grid = $("trophyGrid");
      const count = $("trophyCount");
      if(!section || !grid || !count) return;

      const state = loadTrophyState();
      const unlocked = TROPHIES.filter(t=>!!state[t.id]).length;

      section.style.display = "block";
      count.textContent = `${unlocked}/${TROPHIES.length}`;

      grid.innerHTML = "";
      TROPHIES.forEach(t=>{
        const div = document.createElement("div");
        div.className = "trophyBadge" + (state[t.id] ? "" : " locked");

        const img = document.createElement("img");
        img.alt = t.label;
        setImg(img, t.iconKey);

        const lbl = document.createElement("div");
        lbl.className = "trophyLbl";
        lbl.textContent = t.label;

        div.appendChild(img);
        div.appendChild(lbl);
        div.addEventListener("click", ()=>{
          try{ openTrophyInfoModal(t, state, all); }catch(e){}
        });

        grid.appendChild(div);
      });
    }


    function formatNumberFR(n){
      try{ return new Intl.NumberFormat("fr-CH").format(n); }catch(e){ return String(n); }
    }

    function computeTrophyCurrentValue(t, all){
      const prog = getTrophyProgress(all);
      return (t.type === "sessions") ? prog.sessions :
             (t.type === "weeks") ? prog.weeksStreak :
             (t.type === "streak") ? prog.streakDays :
             (t.type === "tonnageKg") ? prog.tonnageKg : 0;
    }

    function openTrophyInfoModal(t, state, all){
      const modal = $("trophyModal");
      if(!modal) return;

      const unlocked = !!state[t.id];
      const cur = computeTrophyCurrentValue(t, all);
      const need = t.threshold;

      setImg($("trophyModalImg"), t.iconKey);
      $("trophyModalTitle").textContent = t.title || t.label;
      // If locked, show progress line appended
      const progressLine = unlocked ? "" : `\n\nProgression : ${formatNumberFR(cur)} / ${formatNumberFR(need)}`;
      $("trophyModalDesc").textContent = (t.desc || "") + progressLine;
      $("trophyModalMini").textContent = unlocked ? "Troph√©e d√©bloqu√©" : "Troph√©e verrouill√©";

      // When opening from history, OK just closes (doesn't consume queue)
      __trophyQueue = [];
      __trophyInfoMode = true;
      const nextBtn = $("trophyModalNext");
      if(nextBtn) nextBtn.style.display = "none";

      // Set OK button to close (temporary override)
      const ok = $("trophyModalOk");
      if(ok){
        ok.textContent = "Fermer";
        
      }

      modal.classList.remove("hidden");
    }

    // --- Modal / popup ---
    let __trophyQueue = [];
    let __trophyInfoMode = false;
    function openTrophyModalFor(id){
      __trophyInfoMode = false;
      const t = TROPHIES.find(x=>x.id===id);
      if(!t) return;

      const modal = $("trophyModal");
      if(!modal) return;

      setImg($("trophyModalImg"), t.iconKey);
      $("trophyModalTitle").textContent = t.title || t.label;
      $("trophyModalDesc").textContent = t.desc || "";
      $("trophyModalMini").textContent = "Nouveau troph√©e d√©bloqu√©";

      // Ensure modal buttons are in "reward" mode
      const ok = $("trophyModalOk");
      if(ok){ ok.textContent = "OK"; ok.onclick = null; }

      const nextBtn = $("trophyModalNext");
      if(nextBtn) nextBtn.style.display = (__trophyQueue.length > 0) ? "inline-flex" : "none";

      modal.classList.remove("hidden");
    }

    function closeTrophyModal(){
      const modal = $("trophyModal");
      if(modal) modal.classList.add("hidden");
    }

    function showPendingTrophiesModal(){
      const ids = loadPendingTrophies();
      if(!ids.length) return;

      // queue everything and show first
      __trophyQueue = ids.slice(1);
      openTrophyModalFor(ids[0]);
    }

    function consumeCurrentAndShowNext(){
      // remove what we're currently showing by shifting from saved pending list
      const ids = loadPendingTrophies();
      if(ids.length) ids.shift();
      savePendingTrophies(ids);

      if(__trophyQueue.length){
        const nextId = __trophyQueue.shift();
        openTrophyModalFor(nextId);
        const nextBtn = $("trophyModalNext");
        if(nextBtn) nextBtn.style.display = (__trophyQueue.length > 0) ? "inline-flex" : "none";
      }else{
        closeTrophyModal();
      }
    }

    function clearAllPendingAndClose(){
      __trophyInfoMode = false;
      savePendingTrophies([]);
      __trophyQueue = [];
      // Restore modal button label if it was overridden
      const ok = $("trophyModalOk");
      if(ok){ ok.textContent = "OK"; ok.onclick = null; }
      closeTrophyModal();
    }

    $("trophyModalClose")?.addEventListener("click", clearAllPendingAndClose);
    $("trophyModalOk")?.addEventListener("click", ()=>{
      if(__trophyInfoMode){ clearAllPendingAndClose(); return; }
      consumeCurrentAndShowNext();
    });
    $("trophyModalNext")?.addEventListener("click", consumeCurrentAndShowNext);


    function formatDateShort(ts){
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { weekday:"short", day:"2-digit", month:"short" });
    }
    function formatHhMmFromSec(sec){
      const m = Math.round((sec||0)/60);
      const h = Math.floor(m/60);
      const mm = m%60;
      if(h<=0) return `${mm} min`;
      return `${h}h${String(mm).padStart(2,"0")}`;
    }

    function computeStreakFromHistory(all){
      const days = new Set(all.map(x=>{
        const d = new Date(x.ts);
        d.setHours(0,0,0,0);
        return d.getTime();
      }));
      let streak = 0;
      const cur = new Date();
      cur.setHours(0,0,0,0);
      while(days.has(cur.getTime())){
        streak++;
        cur.setDate(cur.getDate()-1);
      }
      return streak;
    }


    function startOfISOWeekMs(ts){
      const d = new Date(ts);
      d.setHours(0,0,0,0);
      // Convert JS Sunday=0..Saturday=6 to Monday=0..Sunday=6
      const day = (d.getDay() + 6) % 7;
      d.setDate(d.getDate() - day);
      return d.getTime();
    }

    function computeWeeklyStreakFromHistory(all){
      const weeks = new Set(all.map(x=>startOfISOWeekMs(x.ts)));
      if(weeks.size === 0) return 0;

      let latest = 0;
      weeks.forEach(v=>{ if(v > latest) latest = v; });

      let streak = 0;
      let cur = latest;
      const WEEK_MS = 7*24*3600*1000;

      while(weeks.has(cur)){
        streak++;
        cur -= WEEK_MS;
      }
      return streak;
    }

    function weeklyBuckets8(all){
      const now = new Date();
      now.setHours(0,0,0,0);
      const buckets = Array.from({length:8}, ()=>({ workouts:0, timeSec:0 }));

      // bucket 0 oldest, 7 newest
      for(let i=0;i<8;i++){
        const start = new Date(now);
        start.setDate(start.getDate() - (7*(7-i)) - 6);
        const end = new Date(now);
        end.setDate(end.getDate() - (7*(7-i)) + 1); // exclusive

        all.forEach(x=>{
          if(x.ts >= start.getTime() && x.ts < end.getTime()){
            buckets[i].workouts += 1;
            buckets[i].timeSec += (x.durationSec || 0);
          }
        });
      }
      return buckets;
    }

    function drawBars(canvas, values){
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;

      // Resize (this also clears the canvas)
      const cw = Math.max(1, Math.floor(canvas.clientWidth));
      const ch = Math.max(1, Math.floor(canvas.clientHeight));
      canvas.width  = Math.floor(cw * dpr);
      canvas.height = Math.floor(ch * dpr);

      // Reset transform + clear
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const w = canvas.width, h = canvas.height;
      const pad = 10*dpr;
      const max = Math.max(1, ...values);
      const n = values.length;
      const gap = 6*dpr;
      const barW = (w - pad*2 - gap*(n-1)) / n;

      const color = getComputedStyle(document.documentElement).getPropertyValue("--text").trim() || "#fff";
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.9;

      for(let i=0;i<n;i++){
        const v = values[i];
        const bh = (h - pad*2) * (v / max);
        const x = pad + i*(barW+gap);
        const y = h - pad - bh;
        ctx.fillRect(x, y, barW, bh);
      }
      ctx.globalAlpha = 1;
    }

    let historyRangeDays = 30;

    function filterHistoryByRange(all){
      const cutoff = Date.now() - historyRangeDays*24*3600*1000;
      return all.filter(x => x.ts >= cutoff);
    }

    function renderHistory(){
      const all = loadWorkoutHistory();
      const period = filterHistoryByRange(all);

      const workouts = period.length;
      const timeSec = period.reduce((a,x)=>a+(x.durationSec||0),0);
      const sets = period.reduce((a,x)=>a+(x.setsCount||0),0);
      const streak = computeWeeklyStreakFromHistory(all);

      $("kpiWorkouts").textContent = workouts;
      $("kpiWorkoutsSub").textContent = `sur ${historyRangeDays} semaines`;
      $("kpiTime").textContent = formatHhMmFromSec(timeSec);
      $("kpiSets").textContent = sets ? String(sets) : "‚Äî";
      $("kpiStreak").textContent = String(streak);

      const buckets = weeklyBuckets8(all);
      drawBars($("chartWorkouts"), buckets.map(b=>b.workouts));
      drawBars($("chartTime"), buckets.map(b=>Math.round((b.timeSec||0)/60))); // minutes

      // Render trophies grid
      try{ renderTrophiesSection(all); }catch(e){}

      const list = $("historyList");
      if(!list) return;

      if(period.length === 0){
        list.innerHTML = `<div class="historyItem"><div class="historyName">Aucune s√©ance</div><div class="historyMeta">Commence une s√©ance, elle appara√Ætra ici.</div></div>`;
        // Render trophies even if no sessions in selected range
        try{ renderTrophiesSection(all); }catch(e){}
        return;
      }

      list.innerHTML = period.slice(0, 30).map(x=>{
        const dur = x.durationSec ? formatHhMmFromSec(x.durationSec) : "‚Äî";
        const meta = `${formatDateShort(x.ts)} ‚Ä¢ ${dur}`;
        const line = `${x.exercisesCount||0} exercices ‚Ä¢ ${x.setsCount||0} s√©ries`;
        return `
          <div class="historyItem">
            <div class="historyItemTop">
              <div class="historyName">${escapeHtml(x.sessionName || "S√©ance")}</div>
              <div style="display:flex; align-items:center; gap:8px;">
                <div class="historyMeta">${meta}</div>
                <button class="historyDelBtn" data-delhist="${escapeHtml(x.id)}" aria-label="Supprimer cette entr√©e" title="Supprimer">‚úï</button>
              </div>
            </div>
            <div class="historyLine">${line}</div>
          </div>
        `;
      }).join("");
    }

    function openHistory(){
      showScreen("history");
      // render after layout to get correct canvas sizes
      setTimeout(()=>{
        renderHistory();
        try{ renderTrophiesSection(loadWorkoutHistory()); }catch(e){}
      }, 0);
    }


/***********************
     * Workout state
     ***********************/
    let curSessionId = null;
    let workoutStartMs = null;
    let workoutLogged = false;

    let curSession = null;
    let sessionLoadsUsed = {}; // exoId -> charge utilis√©e pendant CETTE s√©ance

    let seq = [];
    let idx = 0;

    let running = false;
    let timer = null;
    let remaining = 0;

    function mmss(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s/60);
      const r = s%60;
      return String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
    }

    function setPhaseUI(phase, hint){
      const cp = $("chipPhase");
      if(cp) cp.textContent = (phase || "").toString();
      const ph = $("phaseHint");
      if(ph) ph.textContent = hint || "";
    }

    function stopTimer(){
      running = false;
      if(timer){ clearInterval(timer); timer=null; }
      $("btnPlayPause").textContent = "‚ñ∂Ô∏é";
    }

    function startTimer(){
      if(running) return;
      // Guard: don't restart timer on end screen
      if(idx >= seq.length || !seq[idx]){
        $("btnPlayPause").textContent = "‚ñ∂Ô∏é";
        running = false;
        return;
      }
      running = true;
      $("btnPlayPause").textContent = "II";
      let lastTick = Date.now();

      timer = setInterval(()=>{
        const now = Date.now();
        const dt = (now - lastTick) / 1000;
        lastTick = now;
        remaining -= dt;

        const cur = seq[idx];
      const fb = $("finishBar");
      const tc = $("timerCard");
      if(cur){
        if(fb){ fb.classList.add("hidden"); fb.style.display = "none"; }
        if(tc) tc.style.display = "";
      }
        if(cur?.type === "work"){
          if(Math.ceil(remaining) === 3) speak("3");
          if(Math.ceil(remaining) === 2) speak("2");
          if(Math.ceil(remaining) === 1) speak("1");
        }

        if(remaining <= 0){
          clearInterval(timer); timer=null;
          running = false;
          $("btnPlayPause").textContent = "‚ñ∂Ô∏é";
          onPhaseEnd();
          return;
        }
        $("timeText").textContent = mmss(remaining);
      }, 120);
    }

    function onPhaseStart(){
      const cur = seq[idx];
      if(!cur) return;

      remaining = cur.seconds || 0;
      $("timeText").textContent = mmss(remaining);

      if(cur.type === "work"){
        setPhaseUI("Travail", "");
        speak("D√©but de l'exercice");
        beep(880, 80);
      }else if(cur.type === "rest"){
        setPhaseUI("Repos", "");
        speak("D√©but du repos");
        beep(660, 80);
      }else if(cur.type === "warmup" || cur.type === "cooldown"){
        setPhaseUI("√âchauffement", "");
        speak("D√©but de l'√©chauffement");
        beep(740, 80);
      }else{
        setPhaseUI("Pr√™t", "");
      }

      if(cur.type === "rest" && cur.isLastRestOfExercise) showNextOverlay();
      else hideNextOverlay();
    }

    function onPhaseEnd(){
      hideNextOverlay();

      if(coachMode){
        idx = Math.min(seq.length, idx+1);
        renderWorkoutStep();
        startTimer();
      }else{
        idx = Math.min(seq.length, idx+1);
        renderWorkoutStep();
      }
    }

    function setImg(imgEl, iconKey){
      const map = window.IMG || {};
      const path = map[iconKey] || iconKey || "";
      if(!path){
        imgEl.removeAttribute("src");
        imgEl.style.display = "none";
        return;
      }
      imgEl.style.display = "block";
      imgEl.src = path;
    }

    function updateInfoOverlayContent(cur){
      const body = $("infoBody");
      if(!body) return;

      if(cur?.type === "work" || cur?.type === "rest"){
        const e = cur.exo || {};
        const parts = [];

        const howTxt =
          e.how || e.howto || e.do || e.cues || e.tips || "";

        const avoidTxt =
          e.mistakes || e.dont || e.avoid || e.warnings || "";

        if(howTxt){
          parts.push("Comment faire\n" + String(howTxt).trim());
        }
        if(avoidTxt){
          parts.push("Erreurs √† √©viter\n" + String(avoidTxt).trim());
        }

        if(parts.length === 0){
          const fallback = e.desc || e.muscle || "‚Äî";
          parts.push(String(fallback).trim());
        }

        body.textContent = parts.join("\n\n");
      }else if(cur?.type === "warmup"){
        body.textContent = String(cur.desc || "‚Äî");
      }else{
        body.textContent = "‚Äî";
      }
    }

    function openInfo(){
      const ov = $("infoOverlay");
      if(!ov) return;
      ov.classList.add("active");
      ov.setAttribute("aria-hidden", "false");
      renderLoadHistory();
    }
    function closeInfo(){
      const ov = $("infoOverlay");
      if(!ov) return;
      ov.classList.remove("active");
      ov.setAttribute("aria-hidden", "true");
    }

    function getExerciseProgress(){
      const items = curSession?.items || [];
      if(!items.length) return null;
      const cur = seq[idx];
      if(!cur || !cur.exo) return null;
      const i = items.findIndex(e => e === cur.exo);
      if(i === -1) return null;
      return { current: i + 1, total: items.length };
    }

    
    function normalizeStepText(obj){
      if(!obj) return "";
      if(typeof obj === "string") return obj;
      const t = obj.desc ?? obj.todo ?? obj.text ?? obj.instructions ?? obj.instruction ?? obj.note ?? obj.notes ?? obj.do ?? "";
      if(Array.isArray(t)) return t.filter(Boolean).join(" ‚Ä¢ ");
      return String(t || "");
    }
    function normalizeStepIcon(obj){
      if(!obj || typeof obj === "string") return "";
      return obj.icon || obj.gif || obj.img || obj.image || obj.media || "";
    }

function buildSequence(session){
      const out = [];

      (session.warmup || []).forEach((w)=>{
        out.push({
          type:"warmup",
          title: (typeof w === "string") ? w : (w.name || "√âchauffement"),
          desc: normalizeStepText(w),
          seconds: (typeof w === "string") ? 60 : (w.seconds || 60),
          icon: normalizeStepIcon(w)
        });
      });

      (session.items || []).forEach((e)=>{
        const sets = Number(e.sets || 1);
        const work = Number(e.work || (e.type==="time" ? e.seconds : 45) || 45);
        const rest = Number(e.rest || 60);

        for(let s=1; s<=sets; s++){
          out.push({ type:"work", exo:e, setIndex:s, setTotal:sets, seconds:work });
          out.push({ type:"rest", exo:e, setIndex:s, setTotal:sets, seconds:rest, isLastRestOfExercise:(s===sets) });
        }
      });

      // Cooldown / √âtirements (si pr√©sents)
      (session.cooldown || []).forEach((c)=>{
        out.push({
          type:"cooldown",
          title: (typeof c === "string") ? c : (c.name || "√âtirements"),
          desc: normalizeStepText(c),
          seconds: (typeof c === "string") ? 60 : (c.seconds || 60),
          icon: normalizeStepIcon(c)
        });
      });


      return out;
    }

    function renderWorkoutStep(){
      // üîí Always hide finish button by default (only shown on end screen)
      const __fb = $("finishBar");
      if(__fb){
        __fb.classList.add("hidden");
        __fb.style.display = "none";
      }

      stopTimer();

      const cur = seq[idx];
      if(!cur){
        // --- Log workout once when sequence ends ---
        if(!workoutLogged && workoutStartMs){
          const durationSec = Math.max(0, Math.round((Date.now() - workoutStartMs)/1000));
          // Avoid logging super short accidental opens (<45s)
          if(durationSec >= 45){
            const items = curSession?.items || [];
            const exercisesCount = items.length || 0;
            const setsCount = items.reduce((a,e)=>a + Number(e?.sets || 0), 0);

            const all = loadWorkoutHistory();
            all.unshift({
              id: String(Date.now()),
              ts: Date.now(),
              sessionId: curSessionId || "",
              sessionName: curSession?.name || "S√©ance",
              durationSec,
              exercisesCount,
              setsCount,
              tonnageKg: computeSessionTonnageKg(curSession, sessionLoadsUsed)
            });
            saveWorkoutHistory(all.slice(0, 200)); // keep last 200

            // Check & unlock trophies (store pending for popup later)
            try{ evaluateAndUnlockTrophies(all); }catch(e){}
          }
          workoutLogged = true;
        }

        stopTimer();
        hideNextOverlay();
        closeInfo();
        $("workoutTitle").textContent = "F√©licitations";
        $("workoutSubtitle").textContent = "Fin de s√©ance üéâ";
        // Fin de s√©ance GIF (ajoute fin_seance.gif dans /images)
        const gif = pickRandom(FIN_GIFS) || "images/fin_seance.gif";
        setImg($("exoImg"), gif);
        $("todoMain").textContent = "F√©licitations üéâ";
        const __phraseFin = pickRandom(FIN_PHRASES) || "S√©ance termin√©e. Hydrate-toi et pense √† noter tes charges si besoin.";
        $("todoDesc").textContent = __phraseFin;
        // üîä Coach vocal : "S√©ance termin√©e" puis punchline (une seule fois)
        if(coachMode && !__endSpoken){
          speak("S√©ance termin√©e");
          setTimeout(()=>speak(__phraseFin), 900);
          __endSpoken = true;
        }
        $("chipMuscle").textContent = "Bravo";
        $("chipRest").textContent = "Repos: ‚Äî";
        const fb = $("finishBar"); if(fb){ fb.classList.remove("hidden"); fb.style.display = ""; }
        const tc = $("timerCard"); if(tc) tc.style.display = "none";

        const cp = $("chipPhase"); if(cp) cp.textContent = "Termin√©";
        const cs = $("chipSeries"); if(cs) cs.textContent = "‚Äî";
        $("timeText").textContent = "00:00";
        $("btnPlayPause").disabled = true;
        $("btnNext").disabled = true;
        $("btnPrev").disabled = false;

        return;
      }

      $("btnPlayPause").disabled = false;
      $("btnNext").disabled = false;

      let title = "";
      let desc  = "";
      let reps  = "‚Äî";
      let rest  = "‚Äî";
      let imgKey = "";
      let muscle = "‚Äî";
      let todoLine = "‚Äî";

      if(cur.type === "warmup" || cur.type === "cooldown"){
        title = cur.title || (cur.type === "cooldown" ? "√âtirements" : "√âchauffement");
        desc = cur.desc || "";
        imgKey = cur.icon || "";
        $("chipSeries").textContent = (cur.type === "cooldown") ? "√âtire." : "√âchauff.";
        todoLine = "‚Äî";
        muscle = (cur.type === "cooldown") ? "√âtirements" : "√âchauffement";
        rest = "‚Äî";
        currentExoIdForLoad = null;
        updateLoadBadge();
      }else if(cur.type === "work" || cur.type === "rest"){
        const e = cur.exo || {};
        title = e.name || "Exercice";
        desc  = e.todo || e.desc || "";
        reps  = e.reps || (e.type==="time" ? `${e.seconds || e.work || 0}s` : "‚Äî");
        rest  = (e.rest != null) ? (String(e.rest) + "s") : "‚Äî";
        imgKey = e.icon || "";
        muscle = e.muscle || e.group || e.target || "‚Äî";

        const sets = Number(e.sets || cur.setTotal || 1);
        todoLine = `${sets} √ó ${reps}`;
        $("chipSeries").textContent = `S√©rie ${cur.setIndex}/${cur.setTotal}`;

        const exoId = e.id || e.name || title;
        currentExoIdForLoad = exoId;

        updateLoadBadge();
        const inp = $("loadInput");
        if(inp) inp.value = getLastLoad(currentExoIdForLoad) || "";
        renderLoadHistory();
      }

      $("workoutTitle").textContent = title;

      if(cur.type === "warmup" || cur.type === "cooldown"){
        $("workoutSubtitle").textContent = (cur.type === "cooldown") ? "√âtirements" : "√âchauffement";
      }else{
        const p = getExerciseProgress();
        $("workoutSubtitle").textContent = p ? `Exercice ${p.current}/${p.total}` : "Exercice";
      }

      const phaseTxt =
        (cur.type === "work") ? "Travail" :
        (cur.type === "rest") ? "Repos" :
        (cur.type === "warmup") ? "√âchauffement" :
        (cur.type === "cooldown") ? "√âtirements" : "Pr√™t";
      $("chipPhase").textContent = phaseTxt;
      $("chipCoach").textContent = coachMode ? "Coach : ON" : "Coach : OFF";

      setImg($("exoImg"), imgKey);

      $("todoMain").textContent = todoLine;
      $("todoDesc").textContent = desc || "‚Äî";
      $("chipMuscle").textContent = muscle || "‚Äî";
      $("chipRest").textContent = (rest && rest !== "‚Äî") ? `Repos: ${rest}` : "Repos: ‚Äî";

      $("exoDesc").textContent = desc || "‚Äî";
      $("kpiReps").textContent = reps;
      $("kpiRest").textContent = rest;

      const dots = $("setDots");
      if(dots){
        dots.innerHTML = "";
        if(cur.type === "work" || cur.type === "rest"){
          const total = Number(cur.setTotal || 1);
          const current = Number(cur.setIndex || 1);

          for(let s=1; s<=total; s++){
            const d = document.createElement("div");
            d.className = "dot";

            if(cur.type === "work" && s === current) d.classList.add("current");
            const done = (s < current) || (cur.type === "rest" && s <= current);
            if(done){ d.classList.add("done"); d.classList.remove("current"); }
            dots.appendChild(d);
          }
          dots.style.display = "flex";
        }else{
          dots.style.display = "none";
        }
      }

      updateInfoOverlayContent(cur);
      onPhaseStart();
    }

    function startSession(sessionId){
      __endSpoken = false;
      curSessionId = sessionId;
      sessionLoadsUsed = {}; // reset

      curSession = (window.SESSIONS || {})[sessionId];
      workoutStartMs = Date.now();
      workoutLogged = false;

      if(!curSession) return;

      seq = buildSequence(curSession);
      idx = 0;

      showScreen("workout");
      renderWorkoutStep();
    }

    function stepPrev(){
      // Count typed load even if not explicitly saved
      try{ captureCurrentInputToSessionLoads(); }catch(e){}
      stopTimer();
      idx = Math.max(0, idx-1);
      renderWorkoutStep();
    }
    function stepNext(){
      // Count typed load even if not explicitly saved
      try{ captureCurrentInputToSessionLoads(); }catch(e){}
      stopTimer();
      // allow going one step past the last item to reach the end screen
      idx = Math.min(seq.length, idx+1);
      renderWorkoutStep();
    }

    $("btnPrev").addEventListener("click", stepPrev);
    $("btnNext").addEventListener("click", stepNext);

    $("btnPlayPause").addEventListener("click", ()=>{
      if(running) stopTimer();
      else startTimer();
    });

    $("btnFinishHome")?.addEventListener("click", ()=>{
      stopTimer();
      showScreen("home");
      // Popup troph√©es (persistante) apr√®s retour accueil
      try{ setTimeout(()=>showPendingTrophiesModal(), 120); }catch(e){}
    });

$("btnBackHome").addEventListener("click", ()=>{
      stopTimer();
      // Log partial workout if user exits early (optional)
      if(!workoutLogged && workoutStartMs){
        const durationSec = Math.max(0, Math.round((Date.now() - workoutStartMs)/1000));
        if(durationSec >= 120){ // only if meaningful
          const items = curSession?.items || [];
          const exercisesCount = items.length || 0;
          const setsCount = items.reduce((a,e)=>a + Number(e?.sets || 0), 0);

          const all = loadWorkoutHistory();
          all.unshift({
            id: String(Date.now()),
            ts: Date.now(),
            sessionId: curSessionId || "",
            sessionName: (curSession?.name || "S√©ance") + " (arr√™t√©e)",
            durationSec,
            exercisesCount,
            setsCount
          });
          saveWorkoutHistory(all.slice(0, 200));
          workoutLogged = true;
        }
      }

      showScreen("home");
    });

    // --- Historique navigation ---
    $("btnHistory")?.addEventListener("click", openHistory);
    $("btnBackFromHistory")?.addEventListener("click", ()=>showScreen("home"));

    // Range chips
    $("historyFilters")?.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-range]");
      if(!btn) return;
      $("historyFilters").querySelectorAll(".hchip").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      historyRangeDays = parseInt(btn.dataset.range, 10) || 30;
      renderHistory();
    });

    // Clear history
    $("btnClearHistory")?.addEventListener("click", ()=>{
      if(!confirm("Supprimer tout l‚Äôhistorique ?")) return;
      saveWorkoutHistory([]);
      renderHistory();
    });

    // Delete a single history entry
    $("historyList")?.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-delhist]");
      if(!btn) return;
      const id = btn.getAttribute("data-delhist");
      if(!id) return;
      if(!confirm("Supprimer cette s√©ance de l‚Äôhistorique ?")) return;

      const all = loadWorkoutHistory();
      const next = all.filter(x => String(x.id) !== String(id));
      saveWorkoutHistory(next);
      renderHistory();
    });




    $("btnInfo")?.addEventListener("click", openInfo);
    $("btnInfoClose")?.addEventListener("click", closeInfo);
    $("infoOverlay")?.addEventListener("click", (e)=>{ if(e.target?.id === "infoOverlay") closeInfo(); });

    function showNextOverlay(){
      const next = seq.slice(idx+1).find(x=>x.type==="work");
      if(!next || !next.exo) return;

      const e = next.exo;
      $("nextName").textContent = e.name || "Exercice";
      const last = getLastLoad(e.id || e.name) || "";
      $("nextLast").textContent = last ? `Derni√®re charge : ${last}` : "";
      setImg($("nextImg"), e.icon || "");

      $("overlayNext").classList.add("active");
      $("overlayNext").setAttribute("aria-hidden", "false");
    }
    function hideNextOverlay(){
      $("overlayNext").classList.remove("active");
      $("overlayNext").setAttribute("aria-hidden", "true");
    }

    // ----- Auth UI (Login / Signup) -----
    let authMode = "login"; // "login" | "signup"

    function setAuthMode(mode){
      authMode = (mode === "signup") ? "signup" : "login";

      const isSignup = authMode === "signup";
      $("tabLogin")?.classList.toggle("active", !isSignup);
      $("tabSignup")?.classList.toggle("active", isSignup);
      $("tabLogin")?.setAttribute("aria-selected", (!isSignup).toString());
      $("tabSignup")?.setAttribute("aria-selected", (isSignup).toString());

      $("signupName").style.display = isSignup ? "block" : "none";
      $("btnLogin").style.display = isSignup ? "none" : "inline-flex";
      $("btnSignup").style.display = isSignup ? "inline-flex" : "none";

      const pass = $("loginPass");
      pass.setAttribute("autocomplete", isSignup ? "new-password" : "current-password");

      // Clear message when switching mode
      setMsg("");
    }

    $("tabLogin")?.addEventListener("click", ()=>setAuthMode("login"));
    $("tabSignup")?.addEventListener("click", ()=>setAuthMode("signup"));

    function friendlyAuthError(e){
      const code = e?.code || "";
      if(code === "auth/email-already-in-use") return "Ce compte existe d√©j√†. Passe sur ¬´ Se connecter ¬ª.";
      if(code === "auth/invalid-email") return "Email invalide.";
      if(code === "auth/weak-password") return "Mot de passe trop court (minimum 6 caract√®res).";
      if(code === "auth/missing-password") return "Entre un mot de passe.";
      if(code === "auth/wrong-password") return "Mot de passe incorrect.";
      if(code === "auth/user-not-found") return "Compte introuvable. Essaie ¬´ Cr√©er un compte ¬ª.";
      if(code === "auth/too-many-requests") return "Trop de tentatives. R√©essaie dans quelques minutes.";
      return (e?.message || String(e || "Erreur inconnue."));
    }

    $("btnLogin").addEventListener("click", async ()=>{
      setMsg("");
      const email = $("loginEmail").value.trim();
      const pass  = $("loginPass").value;
      if(!email || !pass){
        setMsg("Entre email + mot de passe.");
        return;
      }
      try{
        try{ localStorage.setItem(ELITE_LAST_EMAIL, email); }catch(e){}
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        setMsg("Connexion impossible : " + friendlyAuthError(e));
      }
    });

    $("btnSignup").addEventListener("click", async ()=>{
      setMsg("");
      const name  = ($("signupName").value || "").trim();
      const email = $("loginEmail").value.trim();
      const pass  = $("loginPass").value;

      if(!name){
        setMsg("Entre ton pr√©nom.");
        return;
      }
      if(!email || !pass){
        setMsg("Entre email + mot de passe.");
        return;
      }

      try{
        try{ localStorage.setItem(ELITE_LAST_EMAIL, email); }catch(e){}
        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        // Set Auth displayName
        try{ await updateProfile(cred.user, { displayName: name }); }catch(e){}

        // Ensure Firestore config gets the displayName immediately (so topbar uses it)
        try{
          const cfgRef = doc(db, `users/${cred.user.uid}/profile/config`);
          await setDoc(cfgRef, { displayName: name, sessionsFile: "./sessions.js", sessionsVar: "SESSIONS" }, { merge: true });
        }catch(e){}

        // Ensure profile/main also stores displayName (useful later)
        try{
          const profRef = doc(db, `users/${cred.user.uid}/profile/main`);
          await setDoc(profRef, { displayName: name }, { merge: true });
        }catch(e){}

        setMsg("Compte cr√©√© ‚úÖ (connect√©)");
      }catch(e){
        setMsg("Cr√©ation impossible : " + friendlyAuthError(e));
      }
    });
    $("btnLogout").addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(e){}
    });

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;

      if(!user){
        topbarUserText = "Non connect√©";
        $("userLine").textContent = topbarUserText;
        $("pillStatus").textContent = "üîí";
        $("btnLogout").style.display = "none";
        showScreen("login");
        return;
      }

      $("pillStatus").textContent = "";
      $("btnLogout").style.display = "inline-flex";

      try{
        try{ migrateTrophyStorage(user.uid); }catch(e){}
        await loadUserSessions(user.uid);
/* =========================
   A2-SAFE ‚Äî CUSTOM SESSIONS (Firestore, read-only)
   √Ä COLLER JUSTE APR√àS : await loadUserSessions(user.uid);
   Et JUSTE AVANT : loadCoachMode();
========================= */
try{
  // On utilise le m√™me Firestore que le reste du fichier (db)
  // et on lit les s√©ances custom de l'utilisateur connect√©.
  const snapCustom = await getDocs(collection(db, "users", user.uid, "customSessions"));

  const custom = {};
  snapCustom.forEach((d)=>{
    const data = d.data() || {};
    const key = `CUSTOM_${d.id}`;
    custom[key] = {
      name: data.name || "S√©ance personnalis√©e",
      warmup: Array.isArray(data.warmup) ? data.warmup : [],
      items: Array.isArray(data.items) ? data.items : [],
      cooldown: Array.isArray(data.cooldown) ? data.cooldown : [],
      estimatedMinutes: (typeof data.estimatedMinutes === "number") ? data.estimatedMinutes : null,
      source: "custom"
    };
  });

  // Fusion : les custom d'abord, puis les s√©ances du pack
  if(Object.keys(custom).length){
    window.SESSIONS = { ...custom, ...(window.SESSIONS || {}) };
    console.log("[A2-SAFE] Custom sessions merged:", Object.keys(custom).length);
  }else{
    console.log("[A2-SAFE] No custom sessions found.");
  }
}catch(e){
  console.warn("[A2-SAFE] Custom sessions load failed:", e);
}
/* ===== FIN A2-SAFE ===== */
        loadCoachMode();
        renderHome();
        showScreen("home");
      }catch(e){
        showScreen("login");
        setMsg("Erreur chargement config/s√©ances : " + (e?.message || e));
      }
    });
    // ===== PWA / Service Worker (mise √† jour propre) =====
    if("serviceWorker" in navigator){
      (async ()=>{
        try{
          const reg = await navigator.serviceWorker.register("./service-worker.js");

          // Force an update check on each launch (helps iOS)
          try{ await reg.update(); }catch(e){}

          const banner = $("updateBanner");
          const btnNow = $("updateNow");
          const btnLater = $("updateLater");

          function showBanner(){ if(banner) banner.style.display = "block"; }
          function hideBanner(){ if(banner) banner.style.display = "none"; }

          if(reg.waiting) showBanner();

          reg.addEventListener("updatefound", ()=>{
            const nw = reg.installing;
            if(!nw) return;
            nw.addEventListener("statechange", ()=>{
              if(nw.state === "installed" && navigator.serviceWorker.controller){
                showBanner();
              }
            });
          });

          btnLater?.addEventListener("click", hideBanner);

          btnNow?.addEventListener("click", ()=>{
            const w = reg.waiting;
            if(w) w.postMessage({ type:"SKIP_WAITING" });
          });

          let refreshing = false;
          navigator.serviceWorker.addEventListener("controllerchange", ()=>{
            if(refreshing) return;
            refreshing = true;
            hideBanner();
            location.reload();
          });

        }catch(e){
          // no-op
        }
      })();
    }

    let lastTouchEnd = 0;
    document.addEventListener("touchend", function (event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });

/* =========================
   B2.0-2-SAFE ‚Äî Custom session editor (UI only, no Firestore yet)
========================= */

let CS_DRAFT = null;   // objet en cours d'√©dition
let CS_EDIT_ID = null; // pour plus tard (√©dition), null = cr√©ation


function openCustomSessionEditor(sessionIdOrNull){
  // cr√©ation (pour l'instant)
  CS_EDIT_ID = sessionIdOrNull;
  CS_DRAFT = {
    name: "",
    estimatedMinutes: 35,
    warmup: [],
    items: [],
    cooldown: []
  };

  $("customSessionTitle").textContent = CS_EDIT_ID ? "Modifier une s√©ance" : "Cr√©er une s√©ance";
  $("cs_name").value = CS_DRAFT.name;
  $("cs_minutes").value = CS_DRAFT.estimatedMinutes;

  renderCSEditor();
  showModal("customSessionModal");
}

function closeCustomSessionEditor(){
  hideModal("customSessionModal");
  CS_DRAFT = null;
  CS_EDIT_ID = null;
}

function showModal(id){
  const el = $(id);
  if(!el) return;
  el.classList.remove("hidden");
}

function hideModal(id){
  const el = $(id);
  if(!el) return;
  el.classList.add("hidden");
}

function renderCSEditor(){
  renderWarmupList();
  renderItemsList();
  renderCooldownList();
}

function renderWarmupList(){
  const host = $("cs_warmupList");
  host.innerHTML = "";
  CS_DRAFT.warmup.forEach((w, idx) => {
    const row = document.createElement("div");
    row.className = "csRow";

    const name = document.createElement("input");
    name.className = "input";
    name.placeholder = "Nom (ex: Mobilit√© √©paules)";
    name.value = w.name || "";
    name.oninput = () => { w.name = name.value; };

    const sec = document.createElement("input");
    sec.className = "input mini";
    sec.type = "number";
    sec.min = "10";
    sec.step = "5";
    sec.placeholder = "sec";
    sec.value = w.seconds || 60;
    sec.oninput = () => { w.seconds = Number(sec.value || 0); };

    const del = document.createElement("button");
    del.className = "btn danger";
    del.textContent = "üóëÔ∏è";
    del.onclick = () => { CS_DRAFT.warmup.splice(idx, 1); renderWarmupList(); };

    row.appendChild(name);
    row.appendChild(sec);
    row.appendChild(del);
    host.appendChild(row);
  });
}

function renderItemsList(){
  const host = $("cs_itemsList");
  host.innerHTML = "";
  CS_DRAFT.items.forEach((it, idx) => {
    const row = document.createElement("div");
    row.className = "csRow";

    const name = document.createElement("input");
    name.className = "input";
    name.placeholder = "Exercice (ex: Rowing halt√®re)";
    name.value = it.name || "";
    name.oninput = () => { it.name = name.value; };

    const sets = document.createElement("input");
    sets.className = "input mini";
    sets.type = "number";
    sets.min = "1";
    sets.step = "1";
    sets.placeholder = "sets";
    sets.value = it.sets || 3;
    sets.oninput = () => { it.sets = Number(sets.value || 0); };

    const reps = document.createElement("input");
    reps.className = "input mini";
    reps.placeholder = "reps";
    reps.value = it.reps || "8‚Äì10";
    reps.oninput = () => { it.reps = reps.value; };

    const del = document.createElement("button");
    del.className = "btn danger";
    del.textContent = "üóëÔ∏è";
    del.onclick = () => { CS_DRAFT.items.splice(idx, 1); renderItemsList(); };

    row.appendChild(name);
    row.appendChild(sets);
    row.appendChild(reps);
    row.appendChild(del);
    host.appendChild(row);
  });
}

function renderCooldownList(){
  const host = $("cs_cooldownList");
  host.innerHTML = "";
  CS_DRAFT.cooldown.forEach((c, idx) => {
    const row = document.createElement("div");
    row.className = "csRow";

    const name = document.createElement("input");
    name.className = "input";
    name.placeholder = "Nom (ex: √âtirement dorsaux)";
    name.value = c.name || "";
    name.oninput = () => { c.name = name.value; };

    const sec = document.createElement("input");
    sec.className = "input mini";
    sec.type = "number";
    sec.min = "10";
    sec.step = "5";
    sec.placeholder = "sec";
    sec.value = c.seconds || 60;
    sec.oninput = () => { c.seconds = Number(sec.value || 0); };

    const del = document.createElement("button");
    del.className = "btn danger";
    del.textContent = "üóëÔ∏è";
    del.onclick = () => { CS_DRAFT.cooldown.splice(idx, 1); renderCooldownList(); };

    row.appendChild(name);
    row.appendChild(sec);
    row.appendChild(del);
    host.appendChild(row);
  });
}

/* Buttons wiring */
(function bindCSEditor(){
  const closeBtn = $("customSessionClose");
  const cancelBtn = $("cs_cancel");
  const addW = $("cs_addWarmup");
  const addI = $("cs_addItem");
  const addC = $("cs_addCooldown");
  const saveBtn = $("cs_save");

  if(closeBtn) closeBtn.onclick = closeCustomSessionEditor;
  if(cancelBtn) cancelBtn.onclick = closeCustomSessionEditor;

  if(addW) addW.onclick = () => {
    CS_DRAFT.warmup.push({ id: `WU-${Date.now()}`, name:"", icon:"", seconds:60 });
    renderWarmupList();
  };

  if(addI) addI.onclick = () => {
    CS_DRAFT.items.push({ id: `IT-${Date.now()}`, name:"", icon:"", sets:3, reps:"8‚Äì10", work:45, rest:90 });
    renderItemsList();
  };

  if(addC) addC.onclick = () => {
    CS_DRAFT.cooldown.push({ id: `CD-${Date.now()}`, name:"", icon:"", seconds:60 });
    renderCooldownList();
  };

  if(saveBtn) saveBtn.onclick = () => {
    // PAS ENCORE Firestore √† cette √©tape
    CS_DRAFT.name = $("cs_name").value.trim();
    CS_DRAFT.estimatedMinutes = Number($("cs_minutes").value || 0);

    console.log("[B2.0-2] Draft ready (not saved yet):", CS_DRAFT);
    alert("B2.0-2 OK ‚úÖ (pas encore sauvegard√©). Prochaine √©tape = Firestore.");
    closeCustomSessionEditor();
  };
})();
 
/* ===== FIN B2.0-2-SAFE ===== */

  </script>

<div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal-content">
    <div class="modal-header">
      <div class="h2" id="settingsTitle">R√©glages</div>
      <button id="closeSettings" class="icon-btn" aria-label="Fermer">‚úï</button>
    </div>

<!-- =========================
     B2.0-2-SAFE ‚Äî MODAL CREATE/EDIT CUSTOM SESSION
     √Ä COLLER : apr√®s tes autres modals
========================= -->
<div id="customSessionModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="customSessionTitle">
  <div class="modalCard">
    <div class="modalHeader" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div id="customSessionTitle" class="h2" style="margin:0;">Cr√©er une s√©ance</div>
      <button class="btn" type="button" id="customSessionClose" style="min-width:44px;">‚úï</button>
    </div>

    <div class="modalBody" style="margin-top:10px;">
      <div class="muted small">Nom</div>
      <input id="cs_name" class="input" placeholder="Ex: Haut du corps 30 min" />

      <div style="height:10px;"></div>

      <div class="muted small">Dur√©e estim√©e (minutes)</div>
      <input id="cs_minutes" class="input" type="number" min="5" max="180" step="5" value="35" />

      <div style="height:16px;"></div>

      <div class="h2" style="font-size:14px; margin:0 0 6px;">Warmup</div>
      <div id="cs_warmupList" class="csList"></div>
      <button id="cs_addWarmup" class="btn" type="button" style="width:100%;">+ Ajouter un √©chauffement</button>

      <div style="height:16px;"></div>

      <div class="h2" style="font-size:14px; margin:0 0 6px;">Exercices</div>
      <div id="cs_itemsList" class="csList"></div>
      <button id="cs_addItem" class="btn" type="button" style="width:100%;">+ Ajouter un exercice</button>

      <div style="height:16px;"></div>

      <div class="h2" style="font-size:14px; margin:0 0 6px;">Cooldown</div>
      <div id="cs_cooldownList" class="csList"></div>
      <button id="cs_addCooldown" class="btn" type="button" style="width:100%;">+ Ajouter un cooldown</button>
    </div>

    <div class="modalFooter" style="display:flex; gap:10px; margin-top:14px;">
      <button class="btn" type="button" id="cs_cancel" style="flex:1;">Annuler</button>
      <button class="btn" type="button" id="cs_save" style="flex:1;">Enregistrer</button>
    </div>
  </div>
</div>
<!-- ===== FIN B2.0-2-SAFE ===== -->

    <div class="setting-row">
      <span>Th√®me clair / sombre</span>
      <label class="switch" aria-label="Th√®me clair/sombre">
        <input type="checkbox" id="themeToggleModal">
        <span class="slider"></span>
      </label>
    </div>

    <div class="setting-row">
      <span>Mode coach</span>
      <label class="switch" aria-label="Mode coach on/off">
        <input type="checkbox" id="coachToggleModal">
        <span class="slider"></span>
      </label>
    </div>

    <div class="setting-row">
      <span>Profil</span>
      <button class="btn secondary" id="openProfileBtn" type="button">Ouvrir</button>
    </div>

  </div>
</div>



<div id="profileModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
  <div class="modal-content">
    <div class="modal-header">
      <div class="h2" id="profileTitle">Profil</div>
      <button id="closeProfile" class="icon-btn" aria-label="Fermer">‚úï</button>
    </div>

    <div class="setting-row" style="align-items:flex-start;">
      <span>Objectif</span>
      <select id="profileGoal" class="input" style="max-width: 220px;">
        <option value="force">Force</option>
        <option value="hypertrophie">Hypertrophie</option>
        <option value="perte_poids">Perte de poids</option>
        <option value="reprise">Reprise</option>
        <option value="sport">Sport</option>
      </select>
    </div>

    <div class="setting-row" style="align-items:flex-start;">
      <span>Niveau</span>
      <select id="profileLevel" class="input" style="max-width: 220px;">
        <option value="debutant">D√©butant</option>
        <option value="intermediaire">Interm√©diaire</option>
        <option value="avance">Avanc√©</option>
      </select>
    </div>

    <div class="setting-row" style="align-items:flex-start;">
      <span>Jours / semaine</span>
      <input id="profileDays" class="input" type="number" min="1" max="7" step="1" value="3" style="max-width:120px;">
    </div>

    <div class="setting-row" style="align-items:flex-start;">
      <span>Dur√©e (min)</span>
      <input id="profileMinutes" class="input" type="number" min="10" max="120" step="5" value="30" style="max-width:120px;">
    </div>

    <div class="setting-row" style="align-items:flex-start;">
      <span>Mat√©riel</span>
      <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;">
        <label class="chip"><input type="checkbox" value="halteres" class="profileEquip"> Halt√®res</label>
        <label class="chip"><input type="checkbox" value="barre" class="profileEquip"> Barre</label>
        <label class="chip"><input type="checkbox" value="banc" class="profileEquip"> Banc</label>
        <label class="chip"><input type="checkbox" value="poulie" class="profileEquip"> Poulie</label>
        <label class="chip"><input type="checkbox" value="elastiques" class="profileEquip"> √âlastiques</label>
        <label class="chip"><input type="checkbox" value="kettlebell" class="profileEquip"> Kettlebell</label>
      </div>
    </div>

    <div class="setting-row" style="align-items:flex-start;">
      <span>Contraintes</span>
      <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;">
        <label class="chip"><input type="checkbox" value="genou" class="profileConstraint"> Genou</label>
        <label class="chip"><input type="checkbox" value="epaule" class="profileConstraint"> √âpaule</label>
        <label class="chip"><input type="checkbox" value="dos" class="profileConstraint"> Dos</label>
        <label class="chip"><input type="checkbox" value="poignet" class="profileConstraint"> Poignet</label>
      </div>
    </div>

    <div class="setting-row" style="align-items:flex-start;">
      <span>Notes</span>
      <textarea id="profileNotes" class="input" rows="3" placeholder="Ex: √©viter les rotations genou, douleur √©paule..." style="width:220px; resize:vertical;"></textarea>
    </div>

    <div id="profileMsg" class="mini" style="opacity:.85; margin-top:6px;"></div>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="btn secondary" id="profileReset" type="button">R√©initialiser</button>
      <button class="btn primary" id="profileSave" type="button" style="flex:1;">Enregistrer</button>
    </div>
  </div>
</div>


<!-- TROPHY POPUP -->
<div id="trophyModal" class="trophyModal hidden" role="dialog" aria-modal="true" aria-label="Troph√©e d√©bloqu√©">
  <div class="trophyModalCard">
    <button class="trophyModalClose" id="trophyModalClose" aria-label="Fermer">‚úï</button>

    <div class="trophyModalTop">
      <img id="trophyModalImg" alt="Troph√©e" />
      <div class="trophyModalTxt">
        <div class="mini" id="trophyModalMini">Nouveau troph√©e</div>
        <div class="big" id="trophyModalTitle">‚Äî</div>
        <div class="desc" id="trophyModalDesc">‚Äî</div>
      </div>
    </div>

    <div class="trophyModalActions">
      <button class="btn secondary" id="trophyModalNext" style="display:none;">Suivant</button>
      <button class="btn primary" id="trophyModalOk">OK</button>
    </div>
  </div>
</div>


<!-- PWA UPDATE BANNER -->
<div id="updateBanner" style="display:none; position:fixed; left:12px; right:12px; bottom:calc(12px + env(safe-area-inset-bottom)); z-index:9999;">
  <div style="
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 12px; border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(20,20,20,.92);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 18px 60px rgba(0,0,0,.35);
  ">
    <div style="display:flex; flex-direction:column; gap:2px; min-width:0;">
      <div style="font-weight:950; font-size:13px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Mise √† jour disponible</div>
      <div style="font-size:12px; opacity:.8;">Appuie pour charger la nouvelle version.</div>
    </div>
    <div style="display:flex; gap:8px; flex:0 0 auto;">
      <button class="btn secondary" id="updateLater" style="padding:10px 12px;">Plus tard</button>
      <button class="btn primary" id="updateNow" style="padding:10px 12px;">Mettre √† jour</button>
    </div>
  </div>
</div>


<!-- A2-FULL: Read custom sessions from Firestore and merge into SESSIONS (read-only) -->
<script type="module">
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  async function loadCustomSessionsForUser(uid) {
    try {
      const snap = await getDocs(collection(db, "users", uid, "customSessions"));
      const custom = {};
      snap.forEach(doc => {
        const d = doc.data() || {};
        const key = `CUSTOM_${doc.id}`;
        custom[key] = {
          name: d.name || "S√©ance personnalis√©e",
          warmup: Array.isArray(d.warmup) ? d.warmup : [],
          items: Array.isArray(d.items) ? d.items : [],
          cooldown: Array.isArray(d.cooldown) ? d.cooldown : [],
          estimatedMinutes: d.estimatedMinutes || null,
          source: "custom"
        };
      });
      return custom;
    } catch (e) {
      console.warn("Custom sessions load failed:", e);
      return {};
    }
  }

  if (typeof auth !== "undefined" && auth.onAuthStateChanged) {
    auth.onAuthStateChanged(async (user) => {
      if (!user || !window.SESSIONS) return;
      const custom = await loadCustomSessionsForUser(user.uid);
      if (Object.keys(custom).length) {
        window.SESSIONS = { ...custom, ...window.SESSIONS };
        if (typeof window.refreshSessionsList === "function") {
          window.refreshSessionsList();
        }
        console.log("Custom sessions merged:", Object.keys(custom).length);
      }
    });
  }
</script>

</body>
</html>